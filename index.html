<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>CPE Practice</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0c0c14; color: #e8e0d0; font-family: Georgia, serif; }
  ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: #0c0c14; }
  ::-webkit-scrollbar-thumb { background: #2a2a3e; border-radius: 2px; }
  input, textarea, button { font-family: inherit; }
  textarea { -webkit-appearance: none; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(8px) } to { opacity:1; transform:translateY(0) } }
  @keyframes spin { from { transform:rotate(0deg) } to { transform:rotate(360deg) } }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// ── API KEY MANAGEMENT ────────────────────────────────────────────────────────
const LS = {
  get: (k, fallback = null) => { try { const v = localStorage.getItem(k); return v !== null ? JSON.parse(v) : fallback; } catch { return fallback; } },
  set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} },
};

// ── KWT BANK ──────────────────────────────────────────────────────────────────
const KWT_BANK = [
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "John had no previous experience, so nobody thought that he could win the singing competition, but he did.",
    key_word: "ODDS", sentence_start: "Against", sentence_end: "first place in the singing competition.",
    answer: "all the odds, John took",
    explanation: "'Against all the odds' means achieving something despite it being very unlikely. 'Take first place' is synonymous with winning.",
    distractor_notes: "Don't write 'Against all odds' missing the article 'the', as Cambridge often strictly requires it in this specific idiom format."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "You have to arrive early at the airport, otherwise you may miss your flight.",
    key_word: "RESULT", sentence_start: "You have to arrive early at the airport. Failure", sentence_end: "missing your flight.",
    answer: "to do so may result in",
    explanation: "'Failure to do so' is a formal way to say 'if you don't do this'. 'Result in' means to cause something to happen.",
    distractor_notes: "Remember the preposition 'in' after result. 'Result to' is incorrect."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Unlike his brother, he is certainly very intelligent.",
    key_word: "SO", sentence_start: "He is very intelligent. Certainly,", sentence_end: "his brother.",
    answer: "more so than",
    explanation: "'More so than' is used to compare a previously mentioned adjective (intelligent) between two subjects without repeating the adjective.",
    distractor_notes: "Avoid repeating 'intelligent'. The word 'so' replaces it."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "This is not a very popular restaurant, so there are rarely long queues.",
    key_word: "OCCURRENCE", sentence_start: "This restaurant is not very popular and long queues", sentence_end: ".",
    answer: "are a rare occurrence",
    explanation: "'A rare occurrence' is a C2-level collocation meaning something that happens very infrequently.",
    distractor_notes: "Don't forget the article 'a' before 'rare occurrence'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "In Japan, slurping loudly while eating your noodles is not considered impolite, but rather a sign of appreciation.",
    key_word: "DEEMED", sentence_start: "In Japan,", sentence_end: "manners to slurp loudly while eating your noodles, but rather a sign of appreciation.",
    answer: "it is not deemed bad",
    explanation: "'Deem' is a formal synonym for consider or judge. 'Bad manners' equates to 'impolite'.",
    distractor_notes: "'Deemed as' is a common mistake; 'deemed' is followed directly by the adjective/noun."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "They made a mistake, but we should take into account their lack of experience and not judge them too severely.",
    key_word: "ALLOWANCES", sentence_start: "They made a mistake, but we should", sentence_end: "their lack of experience.",
    answer: "make allowances for",
    explanation: "'Make allowances for' means to take special circumstances into consideration before judging someone.",
    distractor_notes: "The collocation is 'make allowances', not 'take allowances'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The government underestimates how much the problem of staff shortages affect the UK's healthcare system.",
    key_word: "EXTENT", sentence_start: "The government underestimates", sentence_end: "problem of staff shortages in the UK's healthcare system.",
    answer: "the extent of the",
    explanation: "'The extent of' means the size, scale, or degree of something.",
    distractor_notes: "Ensure the article 'the' is used correctly: 'the extent of the'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It is rare for a 15-year-old to be self-disciplined.",
    key_word: "ATTRIBUTE", sentence_start: "Self-discipline", sentence_end: "in a 15-year-old.",
    answer: "is a rare attribute",
    explanation: "'Attribute' is a formal noun for a quality or feature regarded as a characteristic or inherent part of someone.",
    distractor_notes: "Needs the verb 'is' and article 'a' to be grammatically complete."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It is difficult to find a cheap and reliable second-hand car these days.",
    key_word: "BY", sentence_start: "A cheap and reliable second-hand car", sentence_end: "these days.",
    answer: "is hard to come by",
    explanation: "The phrasal verb 'come by' means to find or manage to get something, especially something rare or difficult to find.",
    distractor_notes: "'Difficult to come by' is also perfectly acceptable."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Many years of high stress at work resulted in his health deteriorating.",
    key_word: "TOLL", sentence_start: "Many years of high stress at work", sentence_end: "health.",
    answer: "took a toll on his",
    explanation: "'Take a toll on' means to cause damage, suffering, or a negative effect over time.",
    distractor_notes: "The preposition must be 'on', not 'in' or 'over'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "There have been rumours of a takeover of a small company in the London area.",
    key_word: "TALK", sentence_start: "There", sentence_end: "over a small company in the London area.",
    answer: "has been talk of taking",
    explanation: "'Talk of' is used to indicate rumours or discussions about a possibility. 'Taking over' replaces 'a takeover'.",
    distractor_notes: "Watch out for verb agreement: 'There HAS been talk', not 'have been talk'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Most shops bring prices down before Christmas in an attempt to boost sales.",
    key_word: "BID", sentence_start: "", sentence_end: "sales, most shops cut prices before Christmas.",
    answer: "In a bid to boost",
    explanation: "'In a bid to' is a very common journalistic phrase meaning 'in an attempt to'.",
    distractor_notes: "Remember the infinitive 'to' after bid."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I signed up for BJJ classes, but I soon realized that the advanced class was too much for me, so I moved to the intermediate class.",
    key_word: "DEPTH", sentence_start: "Soon after signing up for BJJ classes, I realized", sentence_end: "advanced class, so I moved to the intermediate class.",
    answer: "that I was out of my depth in the",
    explanation: "To be 'out of your depth' means to be in a situation that is too difficult for you to handle.",
    distractor_notes: "The 'that' is optional but often expected for flow. The key idiom is 'out of my depth'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Checking parts for defects and writing reports comes with the job of working in quality control.",
    key_word: "PARCEL", sentence_start: "Checking parts for defects and writing reports", sentence_end: "working in quality control.",
    answer: "is part and parcel of",
    explanation: "'Part and parcel of' is an idiom meaning an essential or unavoidable part of something.",
    distractor_notes: "Don't use 'a part and parcel', drop the article."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "At first glance, his suggestion for improving our service seems to make sense.",
    key_word: "FACE", sentence_start: "On", sentence_end: "improvements in our service makes sense.",
    answer: "the face of it, his suggestion for making",
    explanation: "'On the face of it' means 'at first glance' or 'superficially'. 'Improving' transforms to 'making improvements'.",
    distractor_notes: "Be careful not to confuse 'on the face of it' with 'in the face of' (which means despite)."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Surprisingly, Susan was not offended at all when Sarah insulted her.",
    key_word: "ENOUGH", sentence_start: "Oddly", sentence_end: "Sarah's insults.",
    answer: "enough, Susan took no offence at",
    explanation: "'Oddly enough' or 'Surprisingly enough' are discourse markers. 'Take offence at' means to be offended by.",
    distractor_notes: "'Was not offended by' is also valid, but 'took no offence at' is a stronger C2 structural transformation."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "In all probability, the merger between Peugeot PSA and Fiat Chrysler will lead to job losses.",
    key_word: "LIKELIHOOD", sentence_start: "There", sentence_end: "the merger between Peugeot PSA and Fiat Chrysler will lead to job losses.",
    answer: "is a high likelihood that",
    explanation: "'There is a high/strong likelihood that' replaces 'In all probability'.",
    distractor_notes: "'Is every likelihood that' is another excellent C2 alternative often seen in answer keys."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "\"I was in the middle of washing my hair when you called me\". She said.",
    key_word: "PROCESS", sentence_start: "She said", sentence_end: "washing her hair when I called her.",
    answer: "that she had been in the process of",
    explanation: "To be 'in the process of' doing something means to be actively doing it. Note the backshift in reported speech: 'was' becomes 'had been'.",
    distractor_notes: "Forgetting to backshift the tense ('was in the process') is an automatic fail for this question."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I didn't known that you were ill, otherwise I would have substituted for you.",
    key_word: "HAD", sentence_start: "I would have filled", sentence_end: "that you were ill.",
    answer: "in for you, had I known",
    explanation: "Third conditional inversion ('had I known' instead of 'if I had known') paired with the phrasal verb 'fill in for' (to substitute).",
    distractor_notes: "Don't use 'if' when using the inverted 'had I known' structure."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "They accused him of deceiving people into giving him their money.",
    key_word: "DECEPTION", sentence_start: "He was accused of", sentence_end: ".",
    answer: "obtaining money from people by deception",
    explanation: "'Obtaining money by deception' is a fixed legal/formal phrase for fraud.",
    distractor_notes: "'Getting money' is also accepted, but 'obtaining' is preferred at this level."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Because he was not able to work as fast as the rest of the class, Patrick failed the test.",
    key_word: "PACE", sentence_start: "Patrick's failure to pass the test was due to his inability", sentence_end: "the rest of the class.",
    answer: "to keep pace with",
    explanation: "'Keep pace with' means to move, progress, or work at the same speed as someone or something else.",
    distractor_notes: "Don't write 'keep the pace with'; the idiom does not use the article 'the'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Although people thought they were superior to their rivals, they failed to turn their superiority into goals.",
    key_word: "EDGE", sentence_start: "They were", sentence_end: "their rivals but failed to turn their superiority into goals.",
    answer: "thought to have the edge over",
    explanation: "'Have the edge over' means to have a slight advantage over someone or something. Passive reporting verb 'were thought to' is required here.",
    distractor_notes: "Make sure to include 'the' before edge: 'have the edge over'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If Jack had let me use his car, I would have been able to go to the party.",
    key_word: "USE", sentence_start: "I would have been able to go to the party if Jack", sentence_end: "of his car.",
    answer: "had offered me the use",
    explanation: "'Offer someone the use of something' is a formal, C2-level alternative to 'let someone use'.",
    distractor_notes: "'Had given me the use' is also acceptable, but 'offered' is very common in Cambridge keys."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Trump or Obama? I don't like either politician, but Trump is not quite as bad.",
    key_word: "LESSER", sentence_start: "Trump or Obama? I don't like either politician, but Trump is", sentence_end: ".",
    answer: "the lesser of two evils",
    explanation: "'The lesser of two evils' is an idiom used when you have to choose between two bad options and you select the one that is slightly less bad.",
    distractor_notes: "This is a fixed idiom, do not change 'evils' to any other word."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The CEO thinks he is a good negotiator, but he isn't.",
    key_word: "HALF", sentence_start: "The CEO is not", sentence_end: "he thinks he is.",
    answer: "half as good a negotiator as",
    explanation: "'Not half as [adjective] a [noun] as' is an emphatic way to say someone is not nearly as good as claimed. Notice the position of the article 'a' after the adjective.",
    distractor_notes: "A very common structural mistake is writing 'half as a good negotiator' instead of 'half as good a negotiator'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The first years of a child's life are crucial since they have a huge impact on his or her future emotional life.",
    key_word: "OVERSTATED", sentence_start: "The importance of the first years of a child's life", sentence_end: "since they have a huge impact on his or her future emotional life.",
    answer: "cannot be overstated",
    explanation: "If something 'cannot be overstated', it means it is extremely important.",
    distractor_notes: "Needs the modal verb in passive form: 'cannot be overstated'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Both our physical health and our financial health are the result of a healthy lifestyle.",
    key_word: "CASE", sentence_start: "Just", sentence_end: "with our physical health, our financial health is also the result of a healthy lifestyle.",
    answer: "as is the case",
    explanation: "'As is the case with' is a formal phrase meaning 'just like the situation with'.",
    distractor_notes: "Don't omit 'is': 'as is the case' not 'as the case'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Kate anticipated that she was going to be made redundant and decided to change jobs.",
    key_word: "ANTICIPATION", sentence_start: "", sentence_end: "made redundant, Kate decided to change jobs.",
    answer: "In anticipation of her being",
    explanation: "'In anticipation of' means expecting something to happen. It must be followed by a noun or a gerund structure ('her being').",
    distractor_notes: "The passive gerund 'being made' requires the object pronoun 'her' (or possessive 'Kate's') before it."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It was only after a long discussion that they reached a conclusion.",
    key_word: "DID", sentence_start: "Only", sentence_end: "at a conclusion.",
    answer: "after a long discussion did they arrive",
    explanation: "When a sentence starts with 'Only after...', it triggers subject-auxiliary inversion in the main clause ('did they arrive'). Also, 'reach a conclusion' becomes 'arrive at a conclusion'.",
    distractor_notes: "If you don't invert to 'did they arrive', the answer is completely wrong in Cambridge grading."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The issue of climate change is closely connected with that of energy consumption.",
    key_word: "BOUND", sentence_start: "The issue of energy consumption is closely", sentence_end: "that of climate change.",
    answer: "bound up with",
    explanation: "'Bound up with' (or 'bound up in') means closely connected to or involved in something else.",
    distractor_notes: "The preposition must be 'with' or 'in'. 'Bound to' means something entirely different (certain to happen)."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Elon Musk is an extraordinary businessman.",
    key_word: "NOTHING", sentence_start: "As a businessman, Elon Musk", sentence_end: "extraordinary.",
    answer: "is nothing if not",
    explanation: "'Be nothing if not' is an idiom used to emphasize that someone or something has a lot of a particular quality.",
    distractor_notes: "Don't confuse this with 'is nothing but'. 'Nothing if not' specifically emphasizes the adjective that follows."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Your password should not, on any account, be disclosed to unauthorised individuals.",
    key_word: "NO", sentence_start: "On", sentence_end: "your password be disclosed to unauthorised individuals.",
    answer: "no account should",
    explanation: "Negative inversion. When a sentence starts with 'On no account', the subject and auxiliary verb must be inverted.",
    distractor_notes: "Failing to invert ('On no account your password should') is a classic error in this type of transformation."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "At first Curtis didn't want his son to be a singer, but he eventually changed his mind.",
    key_word: "ROUND", sentence_start: "At first Curtis didn't want his son to be a singer, but he eventually", sentence_end: "idea.",
    answer: "came round to the",
    explanation: "The phrasal verb 'come round to (an idea)' means to change your opinion and agree with someone or accept something you previously opposed.",
    distractor_notes: "You need the preposition 'to' and the article 'the' to connect with 'idea'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "His opinions are greatly respected by local authorities since he has decades of experience in the subject.",
    key_word: "WEIGHT", sentence_start: "Because he has decades of experience in the subject, his opinions", sentence_end: "local authorities.",
    answer: "carry great weight with",
    explanation: "'Carry weight with' means to be considered serious and important enough to influence someone.",
    distractor_notes: "'Carry a lot of weight with' is also completely acceptable here."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "They say that outside the actor's mansion there was a group of reporters carrying cameras.",
    key_word: "ARMED", sentence_start: "A group of reporters", sentence_end: "to be outside the actor's mansion.",
    answer: "armed with cameras were said",
    explanation: "'Armed with' can be used metaphorically to mean carrying equipment. The structure 'were said to be' is the passive reporting of 'they say that there was'.",
    distractor_notes: "Don't forget the passive auxiliary 'were' before 'said'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He had unrealistic expectations that didn't match his skill level.",
    key_word: "LINE", sentence_start: "His expectations", sentence_end: "his skill level.",
    answer: "were out of line with",
    explanation: "'Out of line with' means not in agreement with or not matching something.",
    distractor_notes: "Ensure the verb matches the plural noun: 'were' out of line, not 'was'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "We need to begin preparing everything for next week's event.",
    key_word: "MAKE", sentence_start: "We need to", sentence_end: "everything ready for next week's event.",
    answer: "make a start on getting",
    explanation: "'Make a start on' means to begin doing something. 'Getting everything ready' replaces 'preparing everything'.",
    distractor_notes: "The preposition for the idiom is 'on' followed by the gerund 'getting'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "\"What do you think about Sally's new boyfriend?\" asked Peter.",
    key_word: "MADE", sentence_start: "Peter", sentence_end: "of Sally's new boyfriend.",
    answer: "asked me what I made",
    explanation: "'What do you make of...' is an idiom meaning 'what is your opinion of...'. It needs to be transformed into reported speech.",
    distractor_notes: "Since Peter is asking a question directly to the speaker, you need to add the object 'me' and backshift to past tense 'made'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "In 1995 the internet was relatively new and Amazon had only just begun selling goods.",
    key_word: "IN", sentence_start: "In 1995 the internet was relatively new and Amazon", sentence_end: "infancy.",
    answer: "was in its",
    explanation: "'In its infancy' is an idiom used to describe something that is very new and still developing.",
    distractor_notes: "Don't use 'at its infancy'. The correct preposition is 'in'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "On my first day at work, my colleague Sam tried very hard to make me feel welcome.",
    key_word: "WAY", sentence_start: "On my first day at work, my colleague Sam", sentence_end: "to make me feel welcome.",
    answer: "went out of his way",
    explanation: "'Go out of your way to do something' means to make a special effort to do something, usually to help someone.",
    distractor_notes: "The possessive must match 'Sam', so 'his way' (or 'her way' depending on the assumed gender, though 'his' is standard in the key)."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Nobody should be surprised at me getting a promotion. I've worked very hard for it.",
    key_word: "COME", sentence_start: "It", sentence_end: "that I'm getting a promotion. I've worked very hard for it.",
    answer: "should not come as a surprise to anyone",
    explanation: "'Come as a surprise to someone' is a fixed collocation. 'Nobody should be surprised' transforms to 'It should not come as a surprise to anyone'.",
    distractor_notes: "You need 'to anyone' or 'to anybody' at the end to account for the word 'Nobody' in the original sentence."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "John, I don't completely agree with what you are saying.",
    key_word: "POINT", sentence_start: "John, I agree with what you are saying, but", sentence_end: ".",
    answer: "only up to a point",
    explanation: "'Up to a point' means partly, or to some extent but not completely.",
    distractor_notes: "'Up to a certain point' is also totally valid. Don't write 'until a point'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He is very realistic about what it takes to start an online business.",
    key_word: "ILLUSION", sentence_start: "He is", sentence_end: "about what it takes to start an online business.",
    answer: "under no illusion",
    explanation: "To be 'under no illusion' (or 'not under any illusion') means to fully understand the reality of a situation and not hold false beliefs about it.",
    distractor_notes: "The preposition is 'under', not 'in' or 'with'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It is true to some extent that technology is making our lives easier.",
    key_word: "WAY", sentence_start: "", sentence_end: "technology is making our lives easier.",
    answer: "In a way,",
    explanation: "'In a way' is a discourse marker used to say that something is partly true, similar to 'to some extent'.",
    distractor_notes: "Needs the comma at the end if the gap requires it structurally, though Cambridge usually ignores punctuation in the final score."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Facebook is certainly not a good substitute for real friendship.",
    key_word: "MEANS", sentence_start: "It is", sentence_end: "that Facebook is a good substitute for real friendship.",
    answer: "by no means certain",
    explanation: "'By no means' is an emphatic way of saying 'not at all' or 'certainly not'. Here it modifies the adjective 'certain'.",
    distractor_notes: "Don't confuse 'by no means' with 'by all means' (which means of course/yes)."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "In view of the fact that his answers were strikingly similar to those of another student, Andrew was accused of cheating on his exams.",
    key_word: "RESEMBLANCE", sentence_start: "In view of the fact that his answers", sentence_end: "those of another student, Andrew was accused of cheating on his exams.",
    answer: "bore a striking resemblance to",
    explanation: "'Bear a resemblance to' means to look like or be similar to someone or something. 'Striking' collocates perfectly to mean 'very noticeable'.",
    distractor_notes: "Make sure you use the past tense 'bore' to match the original 'were'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If the company doesn't increase its turnover this year, many jobs will be at risk.",
    key_word: "LINE", sentence_start: "Many jobs will be", sentence_end: "the company not increase its turnover this year.",
    answer: "on the line, should",
    explanation: "Two things tested here: 'on the line' is an idiom meaning 'at risk', and 'should' is used for conditional inversion replacing 'if'.",
    distractor_notes: "If you forget the inverted 'should' for the conditional clause, the sentence loses grammatical sense."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If you are not able to pay in cash for a car, we can offer you the option of paying in flexible monthly instalments.",
    key_word: "POSITION", sentence_start: "Should", sentence_end: "pay in cash for a car, we can offer you the option of paying in flexible monthly instalments.",
    answer: "you not be in a position to",
    explanation: "Again, conditional inversion ('Should you not be...' instead of 'If you are not...'). 'Be in a position to' means to be able to do something.",
    distractor_notes: "Inverted negatives with 'should' keep the 'not' after the subject: 'Should you not be'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "We don't have enough budget, which basically means that we won't be able to finish the project.",
    key_word: "BOTTOM", sentence_start: "If we don't have enough budget, we won't be able to finish the project. That's", sentence_end: ".",
    answer: "the bottom line",
    explanation: "'The bottom line' is an idiom meaning the fundamental and most important factor.",
    distractor_notes: "Don't write 'at the bottom line'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "They decided to postpone accepting the proposal until more information were disclosed.",
    key_word: "HOLD", sentence_start: "Until more information were disclosed, they made", sentence_end: "the proposal.",
    answer: "the decision to hold off accepting",
    explanation: "'Make the decision to' replaces 'decided to'. 'Hold off doing something' is a phrasal verb meaning to delay doing it.",
    distractor_notes: "Remember that 'hold off' takes the gerund ('accepting'), not the infinitive."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The washing machine destroyed my silk shirt.",
    key_word: "TATTERS", sentence_start: "The washing machine", sentence_end: ".",
    answer: "reduced my silk shirt to tatters",
    explanation: "'Reduce something to tatters' is an idiom meaning to completely destroy or ruin something, often cloth or arguments.",
    distractor_notes: "You must include the object 'my silk shirt' between 'reduced' and 'to tatters'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I know his name but I can't quite remember it.",
    key_word: "TIP", sentence_start: "His name's", sentence_end: ".",
    answer: "on the tip of my tongue",
    explanation: "If something is 'on the tip of your tongue', you are sure that you know it but you cannot remember it at that exact moment.",
    distractor_notes: "Don't write 'at the tip' or 'in the tip'. The correct preposition is 'on'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "She didn't try to hide her feelings, but said his new plan was \"silly\".",
    key_word: "WORDS", sentence_start: "She didn't", sentence_end: "but said his new plan was \"silly\".",
    answer: "mince her words",
    explanation: "'Not mince your words' means to say exactly what you think, even if it might offend someone.",
    distractor_notes: "The negative is already provided by 'didn't', so you just need 'mince her words'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Please say what you really think about the plan, even if you disagree.",
    key_word: "SPEAK", sentence_start: "Please", sentence_end: "about the plan, even if you disagree.",
    answer: "speak your mind",
    explanation: "'Speak your mind' means to say exactly what you think about something very directly.",
    distractor_notes: "Don't write 'speak what you think' or 'speak your thoughts'. The idiom is fixed as 'speak your mind'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The truth about the stolen money was revealed in the investigation.",
    key_word: "LIGHT", sentence_start: "The truth about the stolen money", sentence_end: "the investigation.",
    answer: "came to light in",
    explanation: "If information 'comes to light', it becomes known publicly.",
    distractor_notes: "You need the past tense 'came' to match 'was revealed', plus the preposition 'in' to connect to 'the investigation'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The woman I had just met told me to use her first name when they spoke to her.",
    key_word: "BY", sentence_start: "The woman I had just met told me to", sentence_end: "when I spoke to her.",
    answer: "call her by her first name",
    explanation: "'Call someone by their first name' means to address them informally using their given name.",
    distractor_notes: "Make sure to include 'her' twice: 'call HER by HER first name'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The recent poor examination results raise the issue of the effectiveness of our teaching methods.",
    key_word: "QUESTION", sentence_start: "The recent poor examination results", sentence_end: "the effectiveness of our teaching methods.",
    answer: "call into question",
    explanation: "'Call into question' means to cause doubts about something.",
    distractor_notes: "Don't write 'call to question' or 'put into question'. The strict C2 collocation is 'call into question'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "These books just aren't on the same level.",
    key_word: "LEAGUE", sentence_start: "These books just", sentence_end: ".",
    answer: "aren't in the same league",
    explanation: "If two things are not 'in the same league', one is much better than the other or they are of completely different qualities.",
    distractor_notes: "Needs the negative verb 'aren't' and the preposition 'in'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He felt extremely tired after staying up very late to finish his school project.",
    key_word: "OIL", sentence_start: "He felt extremely tired after", sentence_end: "to finish his school project.",
    answer: "burning the midnight oil",
    explanation: "'Burn the midnight oil' means to stay up very late working or studying.",
    distractor_notes: "The preposition 'after' requires the gerund form 'burning'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "You never continue with sth until it is finished.",
    key_word: "THROUGH", sentence_start: "You never", sentence_end: "to the end.",
    answer: "follow things through",
    explanation: "'Follow through' means to continue doing something until it has been completed.",
    distractor_notes: "You need an object like 'things' or 'it' between follow and through, but 'follow things through' is the standard key here."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Although we were all encouraging her to climb up the tree, she refused.",
    key_word: "EGG", sentence_start: "Although we were all", sentence_end: "to climb up the tree, she refused.",
    answer: "egging her on",
    explanation: "'Egg someone on' is a phrasal verb meaning to strongly encourage someone to do something that might not be a very good idea.",
    distractor_notes: "Remember to include the pronoun 'her' between 'egging' and 'on'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "My financial problems are putting pressure on me.",
    key_word: "WEIGHING", sentence_start: "My financial problems", sentence_end: "me.",
    answer: "are weighing on",
    explanation: "'Weigh on someone' means to cause someone a lot of worry or anxiety.",
    distractor_notes: "Don't use 'weighing over' or 'weighing in'. The correct preposition to express pressure or burden is 'on'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The school play has really lasted too long.",
    key_word: "DRAGGING", sentence_start: "The school play is", sentence_end: ".",
    answer: "really dragging on",
    explanation: "If an event or process 'drags on', it continues for longer than is necessary or expected.",
    distractor_notes: "The phrasal verb is 'drag on', do not use 'dragging out' in this specific context."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Jim is progressing too slowly with his school project.",
    key_word: "BEHIND", sentence_start: "Jim has", sentence_end: "with his school project.",
    answer: "fallen behind",
    explanation: "'Fall behind' means to fail to do something fast enough or on time.",
    distractor_notes: "You must use the past participle 'fallen' after the auxiliary 'has'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The social unrest is not going to become less intense in just a few hours.",
    key_word: "DIE", sentence_start: "The social unrest is not", sentence_end: "in just a few hours.",
    answer: "going to die down",
    explanation: "'Die down' means to gradually become less loud, strong, or active.",
    distractor_notes: "Don't confuse 'die down' with 'die out' (which means to become extinct)."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "She didn't really sing. She just opened and closed her mouth saying nothing.",
    key_word: "WORDS", sentence_start: "She didn't really sing. She just", sentence_end: ".",
    answer: "mouthed the words",
    explanation: "'Mouth the words' means to form words with your lips without making any sound.",
    distractor_notes: "Ensure the verb 'mouth' is in the past tense ('mouthed') to match the original sentence."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I never allow my mother in law to interfere into my affairs.",
    key_word: "NOSE", sentence_start: "I never allow my mother in law", sentence_end: "my affairs.",
    answer: "to nose into",
    explanation: "'Nose into' is an informal phrasal verb meaning to try to discover things that do not involve you.",
    distractor_notes: "The infinitive 'to' is required after 'allow someone...'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "You may not like the school rules, but you have to obey to avoid trouble.",
    key_word: "TOE", sentence_start: "You may not like the rules, but", sentence_end: "to avoid trouble.",
    answer: "you have to toe the line",
    explanation: "'Toe the line' is an idiom meaning to do what you are ordered or expected to do.",
    distractor_notes: "Watch the spelling: it is 'toe' (dedo del pie), not 'tow' (remolcar)."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He tried to cheer me up because I felt sad.",
    key_word: "MOUTH", sentence_start: "He tried to cheer me up because", sentence_end: ".",
    answer: "I was down in the mouth",
    explanation: "'Down in the mouth' is an informal idiom meaning to be sad or depressed.",
    distractor_notes: "Make sure to change the verb 'felt' to 'was' to fit the structure of the idiom naturally."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It was really embarrassing when you asked what her age was!",
    key_word: "FOOT", sentence_start: "You really", sentence_end: "when you asked what her age was!",
    answer: "put your foot in it",
    explanation: "'Put your foot in it' is an idiom meaning to say something by accident that embarrasses or upsets someone.",
    distractor_notes: "Don't omit 'in it' at the end; the full idiom requires it."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I think you should take the responsibility for what happened.",
    key_word: "SHOULDER", sentence_start: "I think you", sentence_end: "what happened.",
    answer: "should shoulder the responsibility for",
    explanation: "'Shoulder the responsibility' is a C2-level metaphor meaning to accept that you are responsible for something bad or difficult.",
    distractor_notes: "Don't forget the preposition 'for' to connect it with 'what happened'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If only I hadn't answered my teacher back.",
    key_word: "KICKED", sentence_start: "I could", sentence_end: "my teacher back.",
    answer: "have kicked myself for answering",
    explanation: "'I could kick myself for doing something' is an idiom used when you are annoyed with yourself because you did something foolish.",
    distractor_notes: "The preposition 'for' must be followed by the gerund 'answering'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Paul did not like it when you called him shallow.",
    key_word: "BEING", sentence_start: "Paul did not take", sentence_end: "shallow.",
    answer: "lightly being called",
    explanation: "'Not take something lightly' means to be upset or bothered by something. Another very common C2 alternative here is 'kindly to being called'.",
    distractor_notes: "Notice the passive gerund 'being called' is required because Paul is the one receiving the action."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I don't like that colour hair dye.",
    key_word: "LIKING", sentence_start: "That colour hair dye", sentence_end: ".",
    answer: "is not to my liking",
    explanation: "If something is 'to your liking', it suits your taste or preferences.",
    distractor_notes: "The phrase is fixed as 'to my liking'. Do not write 'in my liking' or 'for my liking'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I liked my new teacher immediately.",
    key_word: "LIKING", sentence_start: "I took", sentence_end: "my new teacher.",
    answer: "an instant liking to",
    explanation: "'Take a liking to someone' means to begin to like them. Adding 'instant' captures the meaning of 'immediately'.",
    distractor_notes: "The preposition that follows 'liking' in this idiom is always 'to'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "They criticized the manager's decisions.",
    key_word: "FAULT", sentence_start: "They", sentence_end: "manager's decisions.",
    answer: "found fault with the",
    explanation: "'Find fault with something' means to look for mistakes or complain about it.",
    distractor_notes: "You need the article 'the' before 'manager's' to make the sentence grammatically complete."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "We have very little time left.",
    key_word: "SHORT", sentence_start: "We're", sentence_end: "time.",
    answer: "short of",
    explanation: "'Be short of something' (or 'running short of something') means to not have enough of it.",
    distractor_notes: "Do not use 'short on time' in British English exams; 'short of' is the expected standard collocation."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He remembers his grandmother with love.",
    key_word: "FOND", sentence_start: "He has", sentence_end: "his grandmother.",
    answer: "fond memories of",
    explanation: "To 'have fond memories of' someone or something means to remember them with affection.",
    distractor_notes: "The noun must be plural ('memories') to sound natural in this collocation."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The Christmas break has made me feel more lively.",
    key_word: "LEASE", sentence_start: "The Christmas break has", sentence_end: "life.",
    answer: "given me a new lease of",
    explanation: "'Give someone a new lease of life' is a classic idiom meaning to make someone feel more energetic and active than before.",
    distractor_notes: "In UK English (Cambridge standard) it is 'lease OF life', whereas US English usually says 'lease ON life'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "We'll have to believe him, because we don't know if he really took the money.",
    key_word: "BENEFIT", sentence_start: "We'll have to", sentence_end: "because we don't know if he really took the money.",
    answer: "give him the benefit of the doubt",
    explanation: "'Give someone the benefit of the doubt' means to believe someone's statement, without proof, because you cannot prove they are lying.",
    distractor_notes: "This is a completely fixed idiom. Do not alter any of the articles: 'THE benefit of THE doubt'."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "She can't bear her brother any more.",
    key_word: "PUT", sentence_start: "She can't", sentence_end: "any more.",
    answer: "put up with her brother",
    explanation: "'Put up with' is a phrasal verb meaning to tolerate or endure someone or something unpleasant.",
    distractor_notes: "Don't forget to include the object 'her brother' between the phrasal verb and 'any more'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "His efforts to set up a local youth centre were finally successful.",
    key_word: "BORE", sentence_start: "His efforts to set up a local youth centre", sentence_end: ".",
    answer: "finally bore fruit",
    explanation: "'Bear fruit' is an idiom meaning to produce successful results. Here it is used in the past tense ('bore').",
    distractor_notes: "The adverb 'finally' must be kept to retain the full original meaning ('were finally successful')."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I sympathise with you. We're in the same position.",
    key_word: "BOAT", sentence_start: "I sympathise with you. We", sentence_end: ".",
    answer: "are in the same boat",
    explanation: "To be 'in the same boat' means to be in the same unpleasant or difficult situation as someone else.",
    distractor_notes: "You need the verb 'are' (or 're) to complete the structure properly."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I'm not in the right mood to study now. I'll take a walk first.",
    key_word: "FRAME", sentence_start: "I'm not", sentence_end: "to study now. I'll take a walk first.",
    answer: "in the right frame of mind",
    explanation: "'Frame of mind' refers to the way someone thinks or feels at a particular time (their mood).",
    distractor_notes: "The full collocation is 'in the right frame of mind'. Do not write 'on the right frame'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "They were offended by her manner of speaking.",
    key_word: "OFFENCE", sentence_start: "They", sentence_end: "her manner of speaking.",
    answer: "took offence at",
    explanation: "'Take offence at something' means to feel upset or insulted by it.",
    distractor_notes: "The preposition that follows 'offence' is always 'at', not 'with' or 'by'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "There is plenty of food.",
    key_word: "ABUNDANCE", sentence_start: "Food", sentence_end: ".",
    answer: "is in abundance",
    explanation: "If something is 'in abundance', there is a very large quantity of it.",
    distractor_notes: "Ensure you use the verb 'is' before 'in abundance'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "They are very much in love with each other.",
    key_word: "EYES", sentence_start: "They", sentence_end: "each other.",
    answer: "have eyes only for",
    explanation: "'Have eyes only for someone' means to be exclusively romantically interested in that person.",
    distractor_notes: "Don't write 'only have eyes'. The idiom standard is 'have eyes only for'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I went to the city centre because I wanted to buy new shoes.",
    key_word: "VIEW", sentence_start: "I went to the city centre", sentence_end: "new shoes.",
    answer: "with a view to buying",
    explanation: "'With a view to doing something' is a formal way of saying 'with the intention of doing something'.",
    distractor_notes: "Crucial grammar point: 'with a view to' MUST be followed by the -ing gerund ('buying'), not the infinitive."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He is proud of his achievements.",
    key_word: "TAKES", sentence_start: "He", sentence_end: "his achievements.",
    answer: "takes pride in",
    explanation: "'Take pride in something' is a formal collocation meaning to be proud of it.",
    distractor_notes: "The preposition used with 'pride' here is 'in', not 'of'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The teacher ignored his rude behaviour.",
    key_word: "BLIND", sentence_start: "The teacher", sentence_end: "rude behaviour.",
    answer: "turned a blind eye to his",
    explanation: "'Turn a blind eye to something' means to deliberately ignore something that you know is wrong.",
    distractor_notes: "Since the gap omits 'his' before 'rude behaviour', you must include it in your answer: 'turned a blind eye to his'."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I've decided to change in my life and get a divorce.",
    key_word: "LEAF", sentence_start: "I've decided", sentence_end: "and get a divorce.",
    answer: "to turn over a new leaf",
    explanation: "'Turn over a new leaf' is an idiom meaning to start behaving in a better or completely different way.",
    distractor_notes: "Don't forget the particle 'over'. Although sometimes people say 'turn a new leaf', Cambridge heavily prefers the complete idiom 'turn over a new leaf'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I can't sympathize with him.",
    key_word: "SYMPATHY", sentence_start: "I", sentence_end: "him.",
    answer: "have no sympathy for",
    explanation: "To 'have no sympathy for' someone means that you don't feel sorry for them. This requires changing the verb 'sympathize' to the noun collocation.",
    distractor_notes: "The preposition that follows the noun 'sympathy' here is 'for', not 'with'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I can't really remember how many girlfriends Bob has had.",
    key_word: "TRACK", sentence_start: "I can't", sentence_end: "how many girlfriends Bob has had.",
    answer: "keep track of",
    explanation: "'Keep track of' means to continue to be informed or know about someone or something.",
    distractor_notes: "Don't use 'lose track of' here, as the sentence already has the negative 'can't'. The phrase is 'can't keep track of'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He was rather depressed because he had been fired.",
    key_word: "LOW", sentence_start: "He was", sentence_end: "because he had been fired.",
    answer: "at a low ebb",
    explanation: "'At a low ebb' is an idiom used to describe a state of weakness, low spirits, or lack of success.",
    distractor_notes: "A common error is omitting the article 'a'. The fixed phrase is 'at a low ebb'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He had nothing to do so he decided to see a movie.",
    key_word: "END", sentence_start: "He", sentence_end: "so he decided to see a movie.",
    answer: "was at a loose end",
    explanation: "'At a loose end' (UK) or 'at loose ends' (US) means to have nothing to do and feel a bit bored.",
    distractor_notes: "Remember the verb: 'was at a loose end'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He is never completely relaxed in the presence of his teacher.",
    key_word: "EASE", sentence_start: "He is never", sentence_end: "in the presence of his teacher.",
    answer: "completely at ease",
    explanation: "'At ease' means relaxed and comfortable.",
    distractor_notes: "The adverb 'completely' must be kept from the original sentence to maintain the exact meaning."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "When I was awarded the first prize, I didn't know what to say.",
    key_word: "WORDS", sentence_start: "When I was awarded the first prize,", sentence_end: ".",
    answer: "I was at a loss for words",
    explanation: "'At a loss for words' means unable to think of anything to say, usually due to surprise or shock.",
    distractor_notes: "You must include the subject and verb 'I was' to make the sentence grammatically complete."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Since my wife left me, I am about to lose my mind.",
    key_word: "WITS", sentence_start: "Since my wife left me,", sentence_end: ".",
    answer: "I'm at my wits' end",
    explanation: "'At one's wits' end' means you are so worried, confused, or annoyed that you do not know what to do next.",
    distractor_notes: "Pay attention to the possessive apostrophe in 'wits'' (or 'wit's')."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "We rarely visit our relatives.",
    key_word: "OCCASIONS", sentence_start: "Only", sentence_end: "visit our relatives.",
    answer: "on rare occasions do we",
    explanation: "Negative/restrictive inversion. Sentences starting with 'Only on [time expression]' require the auxiliary verb to be inverted with the subject ('do we visit').",
    distractor_notes: "Failing to invert ('Only on rare occasions we visit') is a very common grammatical mistake."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "You can use my car whenever you want.",
    key_word: "DISPOSAL", sentence_start: "The car", sentence_end: "whenever you want it.",
    answer: "is at your disposal",
    explanation: "If something is 'at your disposal', it is available for you to use whenever or however you wish.",
    distractor_notes: "You need the verb 'is' before 'at your disposal'."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I did everything I could to help him.",
    key_word: "POWER", sentence_start: "I did", sentence_end: "to help him.",
    answer: "everything within my power",
    explanation: "'Within one's power' is a formal collocation meaning within one's ability or authority to do something.",
    distractor_notes: "Don't write 'everything in my power'. The C2 Cambridge key heavily prefers the preposition 'within' for this idiom."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I didn't intend to upset you.",
    key_word: "MY", sentence_start: "It", sentence_end: "upset you.",
    answer: "wasn't my intention to",
    explanation: "Noun phrase transformation. The verb 'intend' is transformed into the noun 'intention'.",
    distractor_notes: "Remember the preposition 'to' after 'intention'. 'Was not my intention' is also perfectly fine."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It's been over a month since the missing businessman was last seen.",
    key_word: "TIME", sentence_start: "The", sentence_end: "over a month ago.",
    answer: "last time the missing businessman was seen was",
    explanation: "Restructuring a 'since' clause with Present Perfect into a 'the last time... was' clause with Simple Past.",
    distractor_notes: "Ensure you include the verb 'was' at the very end to connect properly to 'over a month ago'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Paula is likely to leave before you get there.",
    key_word: "TIME", sentence_start: "By", sentence_end: "Paula is likely to have left.",
    answer: "the time you get there",
    explanation: "'By the time' is used to mean 'when' or 'before', often followed by a perfect tense in the main clause.",
    distractor_notes: "Do not add 'that' after 'time' (e.g., 'By the time that you...'). Keep it concise."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "His handwriting is illegible. I can't understand anything.",
    key_word: "HEAD", sentence_start: "His handwriting is illegible. I can't", sentence_end: "it.",
    answer: "make head or tail of",
    explanation: "'Not be able to make head or tail of something' is an idiom meaning to be completely unable to understand it.",
    distractor_notes: "The negative is already provided by 'can't' in the prompt, so just add the idiom 'make head or tail of'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "She doesn't earn enough to make a living.",
    key_word: "ENDS", sentence_start: "She doesn't earn enough", sentence_end: ".",
    answer: "to make ends meet",
    explanation: "'Make ends meet' is an idiom meaning to have just enough money to pay for the things that you need.",
    distractor_notes: "Make sure it's plural 'ends', not 'end'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I don't make decisions here, so there's nothing I can do.",
    key_word: "HANDS", sentence_start: "I don't make decisions here so", sentence_end: ".",
    answer: "my hands are tied",
    explanation: "If your 'hands are tied', you are not free to behave in the way that you would like, usually due to rules or lack of authority.",
    distractor_notes: "Needs the possessive 'my' to match the subject 'I'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Whatever happens, don't open the door.",
    key_word: "SHOULD", sentence_start: "Under", sentence_end: "open the door.",
    answer: "no circumstances should you",
    explanation: "Negative inversion. Sentences starting with 'Under no circumstances' require the auxiliary verb ('should') before the subject ('you').",
    distractor_notes: "Failing to invert ('Under no circumstances you should') is an automatic fail for this question."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He was so afraid of spiders, that he fainted whenever he saw one.",
    key_word: "FEAR", sentence_start: "Such", sentence_end: "that he fainted whenever he saw one.",
    answer: "was his fear of spiders",
    explanation: "Inversion with 'Such'. 'Such was his fear' is a very formal, literary alternative to 'His fear was so great'.",
    distractor_notes: "Don't forget the verb 'was' right after 'Such'. Inversion is mandatory here."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If you come first, leave the keys on the table.",
    key_word: "COME", sentence_start: "Should", sentence_end: "leave the keys on the table.",
    answer: "you come first",
    explanation: "First conditional inversion using 'Should' instead of 'If' to make the condition sound slightly more formal or less likely.",
    distractor_notes: "Never use 'If' together with the inverted 'Should'."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Don't treat it as unimportant. It's serious.",
    key_word: "LIGHT", sentence_start: "Don't", sentence_end: ". It's serious.",
    answer: "make light of it",
    explanation: "'Make light of something' is an idiom meaning to treat a serious situation as if it is not important.",
    distractor_notes: "You need the object 'it' at the end of the idiom to refer back to the situation."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The woman's actions deserved praise, not criticism.",
    key_word: "BEEN", sentence_start: "The woman's actions", sentence_end: "criticized.",
    answer: "should have been praised not",
    explanation: "'Should have been' is used to criticize past events or express unfulfilled expectations. The parallel structure contrasts 'praised' with 'criticized'.",
    distractor_notes: "Don't forget the negative 'not' before 'criticized'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "There's no way you can succeed.",
    key_word: "BOUND", sentence_start: "You", sentence_end: "fail.",
    answer: "are bound to",
    explanation: "If someone is 'bound to' do something, it is certain that they will do it. 'Failing' is the semantic opposite of 'succeeding'.",
    distractor_notes: "Use the correct auxiliary verb 'are' to complete the grammatical structure."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I don't even know whether he's in town.",
    key_word: "ALL", sentence_start: "For", sentence_end: "be in town.",
    answer: "all I know, he may not",
    explanation: "'For all I know' is an idiom used to emphasize that you have very little information about something.",
    distractor_notes: "The modal 'may' (or 'might') is needed to express the uncertainty."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Tina might not agree with the idea.",
    key_word: "DOUBT", sentence_start: "It's", sentence_end: "Tina will agree with the idea.",
    answer: "open to doubt whether",
    explanation: "If something is 'open to doubt', it is not completely certain. It is usually followed by 'whether' or 'if'.",
    distractor_notes: "'Open to question' is also valid, but the key word provided is strictly DOUBT."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "We were all shocked when he died.",
    key_word: "CAME", sentence_start: "His", sentence_end: "to us all.",
    answer: "death came as a shock",
    explanation: "'Come as a shock' is a strong C2 collocation meaning to cause surprise and distress.",
    distractor_notes: "You need to change the verb 'died' into the noun 'death' to act as the subject of the sentence."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Without her assistance, I'd have failed.",
    key_word: "BEEN", sentence_start: "Had", sentence_end: ", I'd have failed.",
    answer: "it not been for her assistance",
    explanation: "Third conditional inversion. 'Had it not been for' is a formal way to say 'If it hadn't been for'.",
    distractor_notes: "Do not use 'if' when using the inverted 'Had it' structure."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If you went back, you would find out the truth.",
    key_word: "TO", sentence_start: "Were", sentence_end: ", you would find out the truth.",
    answer: "you to go back",
    explanation: "Second conditional inversion. 'Were you to go' is a more formal equivalent of 'If you went'.",
    distractor_notes: "The structure is 'Were + subject + to + infinitive'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I'd sooner stay at home than go out.",
    key_word: "RATHER", sentence_start: "Rather", sentence_end: ", I'll stay at home.",
    answer: "than go out",
    explanation: "'Rather than' is used to give more importance to one thing when two alternatives or preferences are being compared.",
    distractor_notes: "Ensure the verb 'go' remains in the bare infinitive form."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "You should read the instructions before turning it on.",
    key_word: "HAD", sentence_start: "You", sentence_end: "instructions before turning it on.",
    answer: "had better read the",
    explanation: "'Had better' is used to give strong advice or a warning. It is followed by the bare infinitive ('read').",
    distractor_notes: "Don't use 'had better to read'. The 'to' is grammatically incorrect here."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The room urgently needs cleaning.",
    key_word: "HIGH", sentence_start: "It's", sentence_end: "your room.",
    answer: "high time you cleaned",
    explanation: "'It is high time' is an idiom used to say that something should have been done already. It is always followed by a subject and a verb in the past tense (cleaned).",
    distractor_notes: "Using the present tense ('high time you clean') is a very common mistake, but grammatically incorrect here."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I regret going out with him.",
    key_word: "RATHER", sentence_start: "I'd", sentence_end: "out with him.",
    answer: "rather not have gone",
    explanation: "To express regret about a past action using 'would rather', you must use the perfect infinitive ('have gone'). The negative 'not' goes immediately after 'rather'.",
    distractor_notes: "Don't use 'rather to not have gone'. 'Would rather' is followed by the bare infinitive."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He regretted the fact that they had stayed for dinner.",
    key_word: "HADN'T", sentence_start: "He'd", sentence_end: "for dinner.",
    answer: "rather they hadn't stayed",
    explanation: "When expressing a preference about someone else's action in the past using 'would rather', we use the Past Perfect ('hadn't stayed').",
    distractor_notes: "Notice the subject change: 'He'd rather THEY hadn't stayed'. If you omit 'they', the sentence implies he regrets his own action."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I'd prefer to live in the country rather than a city.",
    key_word: "SOONER", sentence_start: "I'd", sentence_end: "a city.",
    answer: "sooner live in the country than",
    explanation: "'Would sooner... than...' is a direct synonym for 'would rather... than...'. It is followed by the bare infinitive.",
    distractor_notes: "Do not use 'to live' after 'would sooner'. It strictly takes the bare infinitive."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I like rock climbing more than swimming.",
    key_word: "PREFER", sentence_start: "I", sentence_end: "swimming.",
    answer: "prefer rock climbing to",
    explanation: "The verb 'prefer' when comparing two nouns or gerunds takes the preposition 'to' (prefer doing X to doing Y).",
    distractor_notes: "Never use 'than' after prefer. 'Prefer X than Y' is a common but incorrect translation from other languages."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "What I would really like is a slice of pizza.",
    key_word: "NOTHING", sentence_start: "There's", sentence_end: "a slice of pizza.",
    answer: "nothing I would like more than",
    explanation: "This is a fixed comparative structure for expressing a strong desire. 'There is nothing I would like more than...' equals 'What I would really like is...'",
    distractor_notes: "Don't forget the comparative word 'more' before 'than'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It's doubtful whether they'll sign the contract.",
    key_word: "OPEN", sentence_start: "It's", sentence_end: "they'll sign the contract.",
    answer: "open to doubt whether",
    explanation: "If something is 'open to doubt' or 'open to question', it means it is not certain.",
    distractor_notes: "The preposition that connects 'open to doubt' with the rest of the clause here is 'whether'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It's out of the question that Tony lied to us.",
    key_word: "CAN'T", sentence_start: "Tony", sentence_end: "us.",
    answer: "can't have lied to",
    explanation: "To express logical impossibility in the past, we use 'can't have' + past participle. 'Out of the question' means impossible.",
    distractor_notes: "Don't forget the preposition 'to' to connect the verb 'lied' to the object 'us'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "What a pity I left my bag at home.",
    key_word: "ONLY", sentence_start: "If", sentence_end: "my bag at home.",
    answer: "only I hadn't left",
    explanation: "To express a regret about a past situation using 'If only', we must use the Past Perfect tense.",
    distractor_notes: "Make sure you use the negative 'hadn't' to contrast with the affirmative 'left' in the original sentence."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "She has never lied to us.",
    key_word: "NO", sentence_start: "On", sentence_end: "lied to us.",
    answer: "no occasion has she",
    explanation: "Negative inversion. When placing a negative phrase like 'On no occasion' at the beginning of the sentence for emphasis, the subject and auxiliary verb must be inverted.",
    distractor_notes: "Failing to invert ('On no occasion she has') will make the answer grammatically invalid."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He both sings and dances.",
    key_word: "ONLY", sentence_start: "Not", sentence_end: "dances.",
    answer: "only does he sing but also",
    explanation: "Negative inversion with 'Not only... but also'. When a sentence begins with 'Not only', the subject and auxiliary verb must be inverted ('does he sing').",
    distractor_notes: "Failing to invert ('Not only he sings') is a classic error. Also, ensure you include 'but also' to complete the correlative conjunction."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The only way to meet him is to make an appointment.",
    key_word: "BY", sentence_start: "Only", sentence_end: "meet him.",
    answer: "by making an appointment will you",
    explanation: "Inversion with 'Only by'. After 'Only by + gerund', the main clause must have inverted word order ('will you meet').",
    distractor_notes: "Don't forget the inversion in the main clause. 'Only by making an appointment you will' is incorrect."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He phones her practically every day.",
    key_word: "GOES", sentence_start: "Hardly", sentence_end: "phoning her.",
    answer: "a day goes by without his",
    explanation: "'Hardly a day goes by without doing something' is a set phrase meaning something happens almost every day. It requires the possessive 'his' (or object 'him') before the gerund.",
    distractor_notes: "Don't omit 'his' before 'phoning'. In C2, the possessive before a gerund is the standard formal structure."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I can't understand her behaviour.",
    key_word: "LOSS", sentence_start: "I am", sentence_end: "her behaviour.",
    answer: "at a loss to understand",
    explanation: "To be 'at a loss to do something' means to not know how to do it or be unable to do it.",
    distractor_notes: "The phrase requires the full infinitive 'to understand', not 'for understanding'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If you weren't advising me, I'd never get through this.",
    key_word: "ADVICE", sentence_start: "Were it", sentence_end: ", I'd never get through this.",
    answer: "not for your advice",
    explanation: "Second conditional inversion. 'Were it not for' is a formal way of saying 'If it wasn't for'.",
    distractor_notes: "You must use the noun 'advice' (with a 'c', not the verb 'advise' with an 's')."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I'll leave the door open because the cat may want to go out.",
    key_word: "CASE", sentence_start: "I'll leave the door open", sentence_end: "out.",
    answer: "in case the cat wants to go",
    explanation: "'In case' is used to express doing something as a precaution. It replaces 'because... may want'.",
    distractor_notes: "Do not use 'in case that' or 'in case of'. Just 'in case' followed by the subject and present tense verb."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Providing you pay in cash, you'll receive a discount.",
    key_word: "AS", sentence_start: "So", sentence_end: "you'll receive a discount.",
    answer: "long as you pay in cash",
    explanation: "'So long as' is a conditional conjunction meaning 'on the condition that' or 'provided that'.",
    distractor_notes: "Since the prompt starts with 'So', you must follow it with 'long as'. 'As long as' is also valid but the prompt dictates the 'So' form."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I would like you to call me Joe.",
    key_word: "BE", sentence_start: "I'd", sentence_end: "Joe.",
    answer: "rather be called",
    explanation: "'Would rather' followed by a passive bare infinitive ('be called') to express a preference about how one is treated or addressed.",
    distractor_notes: "Do not use the infinitive 'to be' after 'would rather'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He regretted the fact that he had stayed for dinner.",
    key_word: "NOT", sentence_start: "He'd", sentence_end: "for dinner.",
    answer: "rather not have stayed",
    explanation: "Expressing past regret about one's own action using 'would rather' requires the perfect infinitive ('have stayed'). The negative 'not' precedes the perfect infinitive.",
    distractor_notes: "Don't confuse this with the structure used for someone else's action (which would use past perfect, e.g., 'He'd rather she hadn't stayed')."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I don't want to stay any longer.",
    key_word: "NOT", sentence_start: "I'd", sentence_end: "any longer.",
    answer: "rather not stay",
    explanation: "'Would rather not' is used to express a negative preference in the present or future. It takes the bare infinitive ('stay').",
    distractor_notes: "Do not put 'to' after rather ('rather not to stay' is wrong)."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Your room urgently needs cleaning.",
    key_word: "HIGH", sentence_start: "It's", sentence_end: "your room.",
    answer: "high time you cleaned",
    explanation: "'It is high time' followed by a subject and past tense verb indicates that something is overdue.",
    distractor_notes: "Remember to use the past tense 'cleaned', not the present 'clean'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If necessary, I'll stay longer.",
    key_word: "BE", sentence_start: "If", sentence_end: ", I'll stay longer.",
    answer: "need be",
    explanation: "'If need be' is a fixed idiom meaning 'if it is necessary'.",
    distractor_notes: "This is a completely fixed phrase. Do not write 'if it need be' or 'if needs be'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I said I'd rather we departed early.",
    key_word: "EXPRESSED", sentence_start: "I", sentence_end: "departure.",
    answer: "expressed my preference for an early",
    explanation: "To 'express a preference for something' is a formal C2 way of saying 'said I'd rather'. The adjective 'early' modifies the noun 'departure'.",
    distractor_notes: "Ensure you use the noun phrase 'preference for', not 'preference to'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If only I hadn't bought that expensive car.",
    key_word: "REGRET", sentence_start: "I", sentence_end: "that expensive car.",
    answer: "regret buying",
    explanation: "The verb 'regret' followed by a gerund ('buying') is used to express sorrow about a past action.",
    distractor_notes: "'Regret having bought' is also acceptable, but 'regret buying' is more concise and standard."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He was imprisoned for having such revolutionary ideas.",
    key_word: "EXTENT", sentence_start: "To such", sentence_end: "he was imprisoned.",
    answer: "an extent were his ideas revolutionary that",
    explanation: "Inversion with 'To such an extent'. When this phrase opens a sentence, it triggers auxiliary inversion ('were his ideas revolutionary').",
    distractor_notes: "You must include 'that' to connect to the result clause ('that he was imprisoned')."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Instead of waiting, I took the bus.",
    key_word: "WAIT", sentence_start: "Rather", sentence_end: ", I took the bus.",
    answer: "than wait",
    explanation: "'Rather than' can be used at the beginning of a sentence. It is followed by the bare infinitive ('wait').",
    distractor_notes: "Do not use 'Rather than waiting' here, as the key specifically aims for the infinitive structure in this exact transformation."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It's a pity she didn't change her mind.",
    key_word: "WISH", sentence_start: "I", sentence_end: "her mind.",
    answer: "wish she had changed",
    explanation: "'Wish' followed by the Past Perfect ('had changed') expresses a regret about a past situation that cannot be altered.",
    distractor_notes: "Using the simple past ('wish she changed') refers to a present desire, which is incorrect here since the original says 'she didn't change' (past event)."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "After being fired from his Job, John felt he needed to take time to think about his situation.",
    key_word: "STOCK", sentence_start: "After being fired from his Job, John felt he needed to", sentence_end: "his situation.",
    answer: "take stock of",
    explanation: "'Take stock of' is an idiom meaning to spend some time thinking about the situation you are in before you decide what to do next.",
    distractor_notes: "Don't forget the preposition 'of' to connect the idiom with 'his situation'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Jack was arrested for careless driving, but Harry used his influence to get him out of trouble.",
    key_word: "PULLED", sentence_start: "Jack was arrested for careless driving, but Harry", sentence_end: "to get him out of trouble.",
    answer: "pulled a few strings",
    explanation: "'Pull strings' (or 'pull a few/some strings') is an idiom meaning to secretly use the influence you have over important people in order to get something or help someone.",
    distractor_notes: "Using 'pulled some strings' is also perfectly correct here."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If the new law is introduced, many small companies will be put out of business.",
    key_word: "DOWN", sentence_start: "If the new law is introduced, many small companies will have", sentence_end: ".",
    answer: "to shut down",
    explanation: "'Shut down' or 'close down' is a phrasal verb meaning to stop operating (for a business). The phrase 'will be put out' transforms to the modal 'will have to'.",
    distractor_notes: "You must include 'to' before the verb (to shut down or to close down)."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The government has adopted a firm position against racism and xenophobia.",
    key_word: "STAND", sentence_start: "The government has", sentence_end: "against racism and xenophobia.",
    answer: "taken a firm stand",
    explanation: "'Take a stand against' means to strongly and publicly express your opposition to something.",
    distractor_notes: "The verb must be in the past participle ('taken') to follow the auxiliary 'has'. 'Taken a firm line' is also a valid C2 alternative."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I was giving a speech when someone's mobile phone rang, and I forgot what I was saying.",
    key_word: "TRAIN", sentence_start: "I was giving a speech when someone's mobile phone rang, and I", sentence_end: ".",
    answer: "lost my train of thought",
    explanation: "'Lose one's train of thought' is an idiom meaning to forget what one was saying or thinking.",
    distractor_notes: "Make sure you include the possessive adjective 'my' (lost MY train of thought)."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I think our neighbours have gone a bit too far with their Christmas decorations this year.",
    key_word: "TOP", sentence_start: "I think our neighbours' Christmas decorations", sentence_end: "this year.",
    answer: "are way over the top",
    explanation: "'Over the top' (sometimes abbreviated as OTT) is an idiom meaning too extreme and not suitable, or demanding too much attention.",
    distractor_notes: "Don't forget the verb 'are'. You can also just say 'are over the top' without 'way'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I was very angry with the referee and had to stop myself from punching him in the face.",
    key_word: "SHORT", sentence_start: "I was very angry with the referee and", sentence_end: "him in the face.",
    answer: "stopped short of punching",
    explanation: "'Stop short of doing something' means to decide not to do something that you almost did.",
    distractor_notes: "Remember to use the gerund form 'punching' after the preposition 'of'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Our company cannot accept the agreement as it is now written. Said the CEO.",
    key_word: "AS", sentence_start: "The CEO said that their company could", sentence_end: "stood.",
    answer: "not accept the agreement as it",
    explanation: "'As it stands' means in its present state or condition. This is a reported speech transformation, so 'cannot' becomes 'could not' and 'stands' becomes 'stood'.",
    distractor_notes: "The negative 'not' must be included here since the prompt gives you the positive auxiliary 'could'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The world needs to rely less on fossil fuels and increase the use of renewable forms of energy.",
    key_word: "REDUCE", sentence_start: "The world needs to", sentence_end: "fossil fuels and increase the use of renewable forms of energy.",
    answer: "reduce its reliance on",
    explanation: "Noun phrase transformation. The verb phrase 'rely less on' transforms into 'reduce its reliance on'.",
    distractor_notes: "You must include the possessive 'its' to make the sentence grammatically complete."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "At the beginning he was opposed to the changes, but I talked to him and he eventually became more reasonable.",
    key_word: "SENSE", sentence_start: "At the beginning he was opposed to the changes, but I eventually managed to talk", sentence_end: "him.",
    answer: "some sense into",
    explanation: "'Talk sense into someone' means to persuade someone to act in a sensible or reasonable way.",
    distractor_notes: "The preposition that connects with the person here is 'into' (talk sense into him)."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It was surprising how fast the project had come together, but we still had a long way to go.",
    key_word: "BY", sentence_start: "We were", sentence_end: "shape, but we still had a long way to go.",
    answer: "surprised by how fast the project had taken",
    explanation: "'Take shape' is an idiom meaning to develop into a clear and definite form. 'It was surprising' is transformed to the passive 'We were surprised by'.",
    distractor_notes: "Don't forget to include 'the project had' to make the subject of 'taken shape' clear."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "There are loads of get-rich-quick books on the internet, but that's not necessarily a good thing.",
    key_word: "PLETHORA", sentence_start: "There", sentence_end: "get-rich-quick books on the internet, but that's not necessarily a good thing.",
    answer: "is a plethora of",
    explanation: "'A plethora of' is a formal, C2-level phrase meaning a very large amount of something, especially a larger amount than you need, want, or can deal with.",
    distractor_notes: "You need the verb 'is' (or ''s') and the preposition 'of' to connect it to the noun phrase."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The coach didn't beat around the bush and gave concise and relevant answers to the questions.",
    key_word: "TO", sentence_start: "The coach's answers to the questions were concise", sentence_end: "point.",
    answer: "and to the",
    explanation: "If something is 'to the point', it is directly related to the topic and expressed without extra, unnecessary words.",
    distractor_notes: "You just need to complete the parallel structure 'concise AND to the point'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "After his gap year working in conservation projects, he went on to study Natural Sciences at Cambridge University.",
    key_word: "PROCEEDED", sentence_start: "After his gap year working in conservation projects,", sentence_end: "Natural Sciences at Cambridge University.",
    answer: "he proceeded to study",
    explanation: "'Proceed to do something' is a formal way of saying 'went on to do something' or 'did something next'.",
    distractor_notes: "Don't forget to include the subject pronoun 'he' to make the main clause grammatical."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "There is fear that the latest tax increase on sales will result in a sharp downturn in spending over coming months.",
    key_word: "RAISED", sentence_start: "The latest tax increase on sales", sentence_end: "a sharp downturn in spending over coming months.",
    answer: "has raised fears of",
    explanation: "'Raise fears of something' is a strong collocation meaning to cause people to be afraid that something bad will happen.",
    distractor_notes: "Ensure 'fears' is in the plural form, and you include the auxiliary 'has' for the present perfect tense."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "John, if you threaten Sophia again, you will have to deal with me. Said Charlie.",
    key_word: "RECKON", sentence_start: "Charlie said to John that if he threatened Sophia again, he", sentence_end: "with.",
    answer: "would have him to reckon",
    explanation: "'To have someone to reckon with' means to have someone to deal with, especially someone powerful or difficult. Note the reported speech backshift ('will' to 'would').",
    distractor_notes: "The structure is 'would have [person] to reckon with'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Although his father is a very well-known singer, Enrique Iglesias became a celebrity himself through his own efforts and talents.",
    key_word: "IN", sentence_start: "Enrique Iglesias' father is a very well-known singer, but he became a celebrity himself", sentence_end: "right.",
    answer: "in his own",
    explanation: "To be successful 'in your own right' means to achieve success because of your own efforts and abilities, not because of someone else you are connected to.",
    distractor_notes: "The idiom is fixed as 'in his/her/their own right'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I didn't at any time try to talk him into leaving the company.",
    key_word: "PERSUADE", sentence_start: "At", sentence_end: "to leave the company.",
    answer: "no time did I try to persuade him",
    explanation: "Negative inversion. When a sentence starts with 'At no time', you must invert the subject and auxiliary verb ('did I try'). 'Persuade' replaces 'talk him into'.",
    distractor_notes: "Failing to invert ('At no time I tried') is incorrect."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "In order to restore growth and employment in our country, we need a change in policy.",
    key_word: "ARE", sentence_start: "There needs to", sentence_end: "to restore growth and employment in our country.",
    answer: "be a change in policy if we are",
    explanation: "'If we are to do something' is a formal conditional structure used to talk about what must happen in order to achieve a goal.",
    distractor_notes: "Don't forget the verb 'be' after 'There needs to'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I think James probably forgot to invite me to his birthday party.",
    key_word: "MAY", sentence_start: "I think James", sentence_end: "invite me to his birthday party.",
    answer: "may have forgotten to",
    explanation: "To express a past possibility, we use 'may have' + past participle ('forgotten').",
    distractor_notes: "Another completely valid answer here is 'may have neglected to'. Both perfectly fit the structure and meaning."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "For Paul, telling the truth is important only to the degree that it helps him to achieve his goals.",
    key_word: "INSOFAR", sentence_start: "Paul tells the", sentence_end: "as it helps him to achieve his goals.",
    answer: "truth only insofar",
    explanation: "'Insofar as' is a formal conjunction meaning 'to the degree that'. Here it is used to limit the extent to which Paul tells the truth.",
    distractor_notes: "Don't forget the word 'only' to keep the exact meaning of the original sentence."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "In the days before computers, not many people knew how to type.",
    key_word: "ADVENT", sentence_start: "Hardly", sentence_end: "of computers.",
    answer: "anyone knew how to type before the advent",
    explanation: "'Hardly anyone' replaces 'not many people'. 'The advent of' means the invention or arrival of something important.",
    distractor_notes: "You can also use 'anybody' instead of 'anyone'. Do not use double negatives like 'Hardly nobody'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "On paper, the agreement looks good, but we still have to see the detail.",
    key_word: "FACE", sentence_start: "The agreement looks good on", sentence_end: "seen the detail yet.",
    answer: "the face of it, but we haven't",
    explanation: "'On the face of it' is an idiom used to describe how a situation seems on the surface or at first glance. 'Still have to see' transforms to 'haven't seen yet'.",
    distractor_notes: "Don't forget the negative auxiliary 'haven't' to connect correctly with 'seen the detail yet'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Adam's comments in the meeting were totally inappropriate and may cause him problems.",
    key_word: "LINE", sentence_start: "Adam's comments in the meeting were", sentence_end: "and may cause him problems.",
    answer: "totally out of line",
    explanation: "'Out of line' means behaving in a way that breaks the rules or is considered inappropriate.",
    distractor_notes: "You must include the adverb 'totally' from the original sentence to convey the same degree of inappropriateness."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Our team gave pretty much everything they had, but we failed to win a game that on paper was supposed to be an easy one.",
    key_word: "SHORT", sentence_start: "Our team gave pretty much everything they had, but we", sentence_end: "a game that on paper was supposed to be an easy one.",
    answer: "came up short in",
    explanation: "'Come up short' is an idiom meaning to fail to reach a goal or standard.",
    distractor_notes: "The past tense 'came' is required to match 'failed'. Also, remember the preposition 'in' before 'a game'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He started studying French because he thought that that would help him find a better job.",
    key_word: "HOPE", sentence_start: "He started studying French", sentence_end: "finding a better job.",
    answer: "in the hope of",
    explanation: "'In the hope of doing something' means because you want something to happen.",
    distractor_notes: "Using 'in hope of' without the article 'the' is also accepted in Cambridge exams."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "It is thought that he had knowledge of CPR and could therefore save her.",
    key_word: "CONVERSANT", sentence_start: "He is thought", sentence_end: "CPR and could therefore save her.",
    answer: "to have been conversant with",
    explanation: "'Be conversant with' means to be familiar with, or have knowledge or experience of something. Passive reporting verb 'is thought' is followed by the perfect infinitive 'to have been' for a past action.",
    distractor_notes: "Don't use the simple infinitive 'to be' here, as the original sentence refers to a past state ('had knowledge')."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Alex has an impressive knowledge of computer programming.",
    key_word: "BREADTH", sentence_start: "The", sentence_end: "computer programming is impressive.",
    answer: "breadth of Alex's knowledge of",
    explanation: "'The breadth of one's knowledge' refers to how wide-ranging or comprehensive their knowledge is.",
    distractor_notes: "Ensure you use the possessive 'Alex's' and the preposition 'of' before 'computer programming'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "When he saw that we were in trouble, he didn't hesitate to help us.",
    key_word: "IN", sentence_start: "When he saw that we were in trouble, he just", sentence_end: "help us.",
    answer: "dived in to",
    explanation: "'Dive in' is a phrasal verb meaning to start doing something suddenly and energetically, often without stopping to think.",
    distractor_notes: "The past tense 'dived' (or 'dove' in US English, but 'dived' is standard here) is needed, followed by the infinitive marker 'to' for the verb 'help'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Abby criticized Damian for calling her out on her behaviour, but at the same time said she wouldn't mind it if he asked her out.",
    key_word: "BREATH", sentence_start: "Abby criticized Damian for calling her out on her behaviour, but", sentence_end: "said she wouldn't mind it if he asked her out.",
    answer: "in the same breath",
    explanation: "'In the same breath' is an idiom used when you say two things that are so different that if one is true, the other must be false.",
    distractor_notes: "A completely fixed idiom. Do not write 'with the same breath'."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I thought the maths exam was going to be very difficult, but it actually was a walk in the park.",
    key_word: "THROUGH", sentence_start: "I thought the maths exam was going to be very difficult, but I", sentence_end: "it.",
    answer: "actually breezed through",
    explanation: "'Breeze through' or 'sail through' is a phrasal verb meaning to do or achieve something very easily. It replaces the idiom 'a walk in the park'.",
    distractor_notes: "You can use either 'breezed through' or 'sailed through'. Don't forget the adverb 'actually'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "When he started using my computer without asking, I had to tell him very firmly not to do it again.",
    key_word: "PUT", sentence_start: "When he started using my computer without asking, I", sentence_end: "down.",
    answer: "had to put my foot",
    explanation: "'Put your foot down' is an idiom meaning to use your authority to stop something from happening.",
    distractor_notes: "Don't forget the modal 'had to' to maintain the obligation from the original sentence."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "In London, he bought a car similar to the one he had when he was living in Dublin.",
    key_word: "ALONG", sentence_start: "In London, he bought a car", sentence_end: "the one he had when he was living in Dublin.",
    answer: "along the lines of",
    explanation: "'Along the lines of' means similar in type to something else.",
    distractor_notes: "The idiom is fixed as 'along the lines of'. Do not use 'along the line of' (singular)."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "You can trust neither a salesman nor a politician.",
    key_word: "AS", sentence_start: "You have just as many reasons to", sentence_end: "a politician.",
    answer: "distrust a salesman as",
    explanation: "Comparative structure. 'Just as many reasons to distrust X as Y' effectively means you can't trust either of them.",
    distractor_notes: "'Not trust a salesman as' is also perfectly acceptable in the exam key."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Lionel Messi is an outstanding sportsman and his country is proud of him.",
    key_word: "CREDIT", sentence_start: "Lionel Messi is an outstanding sportsman and", sentence_end: "country.",
    answer: "a credit to his",
    explanation: "To be 'a credit to' someone or something means to do something that makes them proud.",
    distractor_notes: "Make sure you include the article 'a' and the possessive adjective 'his'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I tactfully refused her offer to go out for dinner in order to avoid offending her.",
    key_word: "NOT", sentence_start: "I tactfully refused her offer to go out for dinner so that she", sentence_end: "offence.",
    answer: "would not take",
    explanation: "'Take offence' means to feel offended. The structure 'so that she would not...' expresses the past purpose of the refusal.",
    distractor_notes: "'Would not take any offence' is also completely valid. Be careful not to use 'did not take' as this expresses a result rather than a purpose."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "He is a successful entrepreneur who has many celebrities as clients.",
    key_word: "COUNTS", sentence_start: "He is a successful entrepreneur who", sentence_end: "his clients.",
    answer: "counts many celebrities among",
    explanation: "'Count someone among' means to include someone in a particular group.",
    distractor_notes: "The correct preposition to connect to 'his clients' is 'among'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "She said she wanted to divorce him, but eventually didn't do it.",
    key_word: "IT", sentence_start: "She said she wanted to divorce him, but didn't go", sentence_end: "end.",
    answer: "through with it in the",
    explanation: "'Go through with something' is a phrasal verb meaning to do something unpleasant or difficult that you have planned or promised to do. 'In the end' replaces 'eventually'.",
    distractor_notes: "You must include the object 'it' to refer back to the divorce."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "In the 2010 World Cup, the Spanish national team performed better than ever before and won the championship.",
    key_word: "THEMSELVES", sentence_start: "In the 2010 World Cup, the Spanish national team", sentence_end: "the championship.",
    answer: "excelled themselves and won",
    explanation: "'Excel oneself' (or 'outdo oneself', 'surpass oneself') means to do something better than one usually does.",
    distractor_notes: "You can also write 'outdid themselves and won' or 'surpassed themselves to win'. Remember to include the conjunction/infinitive to connect to 'the championship'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Although the earthquake happened months ago, it seems that little has been done to repair the damage yet.",
    key_word: "HAVE", sentence_start: "It's been months since the earthquake, but", sentence_end: "repair the damage.",
    answer: "little seems to have been done yet to",
    explanation: "Passive reporting structure 'little seems to have been done'. This uses the perfect passive infinitive to refer back to the past.",
    distractor_notes: "Ensure you use the full structure 'to have been done' and include 'yet to' to connect properly with 'repair'."
  },
 {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Ever since I got bad grades in school, my parents have been hard on me.",
    key_word: "GIVING", sentence_start: "Ever since I got bad grades in school, my parents", sentence_end: "time.",
    answer: "have been giving me a hard",
    explanation: "'Give someone a hard time' is an idiom meaning to deliberately make a situation difficult for someone or to criticize them heavily.",
    distractor_notes: "Don't forget the article 'a' before 'hard'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "John insulted the CEO in the meeting, so there is a good chance he will be dismissed.",
    key_word: "LIKELIHOOD", sentence_start: "John will", sentence_end: "insulting the CEO in the meeting.",
    answer: "in all likelihood be dismissed for",
    explanation: "'In all likelihood' is a formal phrase meaning 'very probably' or 'there is a very good chance'. It must be followed by the passive 'be dismissed' and the preposition 'for'.",
    distractor_notes: "Remember the preposition 'for' to connect to the gerund 'insulting'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The pay increase they offered was roughly what I was expecting.",
    key_word: "LINE", sentence_start: "The pay increase they offered was", sentence_end: "what I was expecting.",
    answer: "in line with",
    explanation: "If something is 'in line with' something else, it is similar to it or at the same level as expected.",
    distractor_notes: "The phrase is 'in line with', not 'on line with' or 'at line with'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "My car is acting up again - I'll have the mechanic have a look at it.",
    key_word: "HAVE", sentence_start: "My car is acting up again - I'll take it to the garage", sentence_end: "at.",
    answer: "to have it looked",
    explanation: "This tests the causative structure 'have something done' (have it looked at) combined with an infinitive of purpose ('to have').",
    distractor_notes: "'To get it looked' is also acceptable, though 'have' directly uses the key word."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "If you feel like going shopping or for a drink, the city centre is within walking distance from the hotel.",
    key_word: "MOOD", sentence_start: "Should", sentence_end: "a drink or for shopping, the hotel is within walking distance from the city centre.",
    answer: "you be in the mood for",
    explanation: "First conditional inversion with 'Should' replacing 'If'. 'Feel like' transforms into the idiom 'be in the mood for'.",
    distractor_notes: "You must include the verb 'be' after the subject 'you': 'Should you be...'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Despite having to deal with increasing criticism from the media, the actor maintained his calm and handled the situation very well.",
    key_word: "FACE", sentence_start: "His calm attitude", sentence_end: "increasing criticism from the media, helped the actor to handle the situation very well.",
    answer: "in the face of",
    explanation: "'In the face of something' means while having to deal with a difficult situation or problem.",
    distractor_notes: "Don't write 'at the face of'. The preposition is strictly 'in'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "Some employers nowadays seem to discriminate against people because of their age.",
    key_word: "WRITE", sentence_start: "Some employers nowadays seem to", sentence_end: "basis of their age.",
    answer: "write people off on the",
    explanation: "'Write someone off' is a phrasal verb meaning to decide that someone is useless or not worth considering. 'Because of' transforms to 'on the basis of'.",
    distractor_notes: "You need the object 'people' in the middle of the phrasal verb, plus 'on the' to complete the phrase 'on the basis of'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The costs of housing, healthcare and education have risen fast, but salaries have not done so at the same rate.",
    key_word: "KEPT", sentence_start: "Salaries haven't", sentence_end: "costs of housing, healthcare and education.",
    answer: "kept up with the fast-rising",
    explanation: "'Keep up with' is a phrasal verb meaning to increase at the same speed or rate as something else.",
    distractor_notes: "You can use 'fast-rising' or simply 'rising' to modify 'costs', as indicated in the Cambridge key. Make sure to include 'the'."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "The burglar got into the building by pretending to be a plumber.",
    key_word: "AS", sentence_start: "The burglar got into the building by", sentence_end: "plumber.",
    answer: "posing as a",
    explanation: "'Pose as someone' is a C2-level phrasal verb meaning to pretend to be someone else in order to deceive people.",
    distractor_notes: "Because of the preposition 'by', the gerund 'posing' is required."
  },
  {
    task_type: "key_word_transformation", difficulty: "C2",
    instructions: "Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",
    original_sentence: "I want to buy a new car, but I'm going to postpone it until I get a promotion at work.",
    key_word: "HOLD", sentence_start: "I'm", sentence_end: "a new car until I get a promotion at work.",
    answer: "going to hold off buying",
    explanation: "'Hold off doing something' means to delay doing it.",
    distractor_notes: "You need 'going to' to express the future intention, and remember that 'hold off' takes the gerund 'buying', not the infinitive."
  },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"After being fired from his job, John felt he needed to think about his situation.",key_word:"STOCK",sentence_start:"After being fired from his job, John felt he needed to",sentence_end:"his situation.",answer:"take stock of",explanation:"'Take stock of' is a fixed idiom meaning to carefully assess or reflect on a situation.",distractor_notes:"Common mistakes: 'make stock of' or 'take stock on' — neither is idiomatic." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"Jack was arrested for careless driving, but Harry used his influence to get him out of trouble.",key_word:"PULLED",sentence_start:"Jack was arrested for careless driving, but Harry",sentence_end:"to get him out of trouble.",answer:"pulled a few strings",explanation:"'Pull strings' means to use one's influence or connections to get something done.",distractor_notes:"Common mistakes: 'pulled the strings' (wrong article)." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"If the new law is introduced, many small companies will be put out of business.",key_word:"DOWN",sentence_start:"If the new law is introduced, many small companies will have",sentence_end:".",answer:"to shut down",explanation:"'Shut down' means to cease operations. The structure requires 'to + infinitive' after 'will have'.",distractor_notes:"Both 'shut down' and 'close down' are accepted." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"The government has adopted a firm position against racism and xenophobia.",key_word:"STAND",sentence_start:"The government has",sentence_end:"against racism and xenophobia.",answer:"taken a firm stand",explanation:"'Take a stand' means to adopt a clear position on an issue.",distractor_notes:"Don't say 'made a stand' — the collocation is 'take a stand'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"I was giving a speech when someone's mobile phone rang, and I forgot what I was saying.",key_word:"TRAIN",sentence_start:"I was giving a speech when someone's mobile phone rang, and I",sentence_end:".",answer:"lost my train of thought",explanation:"'Lose one's train of thought' is a fixed idiom meaning to forget what you were saying due to an interruption.",distractor_notes:"The full idiom is 'train of thought' — you cannot say 'lost my train of thinking'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"I think our neighbours have gone a bit too far with their Christmas decorations this year.",key_word:"TOP",sentence_start:"I think our neighbours' Christmas decorations",sentence_end:"this year.",answer:"are way over the top",explanation:"'Over the top' (OTT) means excessive or exaggerated.",distractor_notes:"Don't confuse 'over the top' with 'on top of'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"I was very angry with the referee and had to stop myself from punching him in the face.",key_word:"SHORT",sentence_start:"I was very angry with the referee and",sentence_end:"him in the face.",answer:"stopped short of punching",explanation:"'Stop short of doing something' means to almost do something extreme but hold back.",distractor_notes:"'stopped short of punching' not 'stopped short to punch' — always followed by -ing." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"Our company cannot accept the agreement as it is now written, said the CEO.",key_word:"AS",sentence_start:"The CEO said that their company could",sentence_end:"stood.",answer:"not accept the agreement as it",explanation:"'As it stood' means 'in its current form/state'. Reported speech requires 'could not accept... as it stood'.",distractor_notes:"The phrase 'as it stood' is a fixed expression meaning 'in its current state'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"The world needs to rely less on fossil fuels and increase the use of renewable energy.",key_word:"REDUCE",sentence_start:"The world needs to",sentence_end:"fossil fuels and increase the use of renewable forms of energy.",answer:"reduce its reliance on",explanation:"'Reliance on' is the noun form of 'rely on'. Testing noun transformation from verb.",distractor_notes:"Don't say 'reduce its reliability on' — 'reliability' has a different meaning." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"At the beginning he was opposed to the changes, but I talked to him and he eventually became more reasonable.",key_word:"SENSE",sentence_start:"At the beginning he was opposed to the changes, but I eventually managed to talk",sentence_end:"him.",answer:"some sense into",explanation:"'Talk sense into someone' means to persuade someone to think more reasonably.",distractor_notes:"The preposition is 'into' not 'to'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"I didn't at any time try to talk him into leaving the company.",key_word:"PERSUADE",sentence_start:"At",sentence_end:"to leave the company.",answer:"no time did I try to persuade him",explanation:"Negative inversion: 'At no time did I...' — when a negative adverbial starts the sentence, auxiliary inversion is required.",distractor_notes:"Don't forget the inversion: 'At no time DID I try' not 'At no time I tried'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"Although his father is a very well-known singer, Enrique Iglesias became a celebrity through his own efforts.",key_word:"IN",sentence_start:"Enrique Iglesias' father is a very well-known singer, but he became a celebrity himself",sentence_end:"right.",answer:"in his own",explanation:"'In one's own right' means independently, through one's own merit.",distractor_notes:"The full idiom is 'in his own right' — don't omit 'his own'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"There are loads of get-rich-quick books on the internet, but that's not necessarily a good thing.",key_word:"PLETHORA",sentence_start:"There",sentence_end:"get-rich-quick books on the internet, but that's not necessarily a good thing.",answer:"is a plethora of",explanation:"'A plethora of' means a large or excessive amount of something. Takes a singular verb ('is').",distractor_notes:"Note: 'There IS a plethora of' not 'There ARE'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"When you go abroad, don't forget to write to me.",key_word:"DROP",sentence_start:"When you go abroad, don't forget",sentence_end:".",answer:"to drop me a line",explanation:"'Drop someone a line' is an idiom meaning to write a short letter or message.",distractor_notes:"The idiom is 'drop a line', not 'drop a letter' or 'drop a note'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"We went out together because I wanted to find out about her news.",key_word:"CATCH",sentence_start:"We went out together because I wanted to",sentence_end:"news.",answer:"catch up with her",explanation:"'Catch up with someone' means to get the latest news from someone you haven't seen for a while.",distractor_notes:"'Catch up WITH her' is the most natural phrasing." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"The new film was barely similar to the book I had read.",key_word:"BORE",sentence_start:"The new",sentence_end:"the book I had read.",answer:"film bore no resemblance to",explanation:"'Bear/bore no resemblance to' means to be completely unlike something.",distractor_notes:"Don't say 'bored no resemblance' — 'bore' is the past tense of 'bear'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"The coach didn't beat around the bush and gave concise and relevant answers to the questions.",key_word:"TO",sentence_start:"The coach's answers to the questions were concise",sentence_end:"point.",answer:"and to the",explanation:"'To the point' means concise and relevant.",distractor_notes:"Don't add extra words — the gap is just 'and to the'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"I want to buy a new car, but I'm going to postpone it until I get a promotion at work.",key_word:"HOLD",sentence_start:"I'm",sentence_end:"a new car until I get a promotion at work.",answer:"going to hold off buying",explanation:"'Hold off doing something' means to delay or postpone. Followed by -ing form.",distractor_notes:"'Hold off buying' not 'hold off to buy' — phrasal verb 'hold off' takes -ing." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"Despite having to deal with increasing criticism from the media, the actor maintained his calm.",key_word:"FACE",sentence_start:"His calm attitude",sentence_end:"increasing criticism from the media, helped the actor to handle the situation very well.",answer:"in the face of",explanation:"'In the face of' means despite or when confronted with adversity.",distractor_notes:"The phrase is 'in the face of' — don't confuse with 'on the face of it'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"Salaries have not risen at the same rate as costs of housing, healthcare and education.",key_word:"KEPT",sentence_start:"Salaries haven't",sentence_end:"costs of housing, healthcare and education.",answer:"kept up with the rising",explanation:"'Keep up with' means to match the pace of something.",distractor_notes:"'Kept up with the rising' — don't say 'kept up to'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"The burglar got into the building by pretending to be a plumber.",key_word:"AS",sentence_start:"The burglar got into the building by",sentence_end:"plumber.",answer:"posing as a",explanation:"'Pose as' means to pretend to be someone else, usually to deceive.",distractor_notes:"'Posing as a plumber' not 'posing like a plumber' — the preposition is 'as'." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"I think James probably forgot to invite me to his birthday party.",key_word:"MAY",sentence_start:"I think James",sentence_end:"invite me to his birthday party.",answer:"may have forgotten to",explanation:"'May have + past participle' expresses possibility about a past event.",distractor_notes:"'May have forgotten to' not 'may have neglected to' — though 'neglected' is also accepted." },
  { task_type:"key_word_transformation",difficulty:"C2",instructions:"Complete the second sentence so that it has a similar meaning to the first, using the word given. Use between 3 and 8 words including the key word.",original_sentence:"For Paul, telling the truth is important only to the degree that it helps him achieve his goals.",key_word:"INSOFAR",sentence_start:"Paul tells the",sentence_end:"as it helps him to achieve his goals.",answer:"truth only insofar",explanation:"'Insofar as' is a formal conjunction meaning 'to the extent that'.",distractor_notes:"'Insofar as' is written as one word. 'In so far as' is also accepted." },
];

// ── HELPERS ───────────────────────────────────────────────────────────────────
function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function buildMCOptions_def(word, definition, allWordData) {
  const others = Object.values(allWordData).filter(d => d.word !== word && d.definition).map(d => d.definition);
  const distractors = shuffleArray(others).slice(0, 3);
  while (distractors.length < 3) distractors.push("none of the above");
  const all = shuffleArray([definition, ...distractors]);
  const letters = ['A','B','C','D'];
  const options = {};
  all.forEach((def, i) => { options[letters[i]] = def; });
  return { options, answer: letters[all.indexOf(definition)] };
}

function buildMCOptions_fill(word, distractors) {
  const pool = [...(distractors || [])].slice(0, 3);
  while (pool.length < 3) pool.push("—");
  const all = shuffleArray([word, ...pool]);
  const letters = ['A','B','C','D'];
  const options = {};
  all.forEach((w, i) => { options[letters[i]] = w; });
  return { options, answer: letters[all.indexOf(word)] };
}

// ── SM-2 ──────────────────────────────────────────────────────────────────────
function sm2Update(record, quality) {
  const now = new Date();
  let { interval = 1, easeFactor = 2.5, lapses = 0, totalReviews = 0 } = record || {};
  totalReviews += 1;
  if (quality < 1) {
    lapses += 1; interval = 1;
  } else {
    if (totalReviews === 1) interval = 1;
    else if (totalReviews === 2) interval = 3;
    else interval = Math.round(interval * easeFactor);
    easeFactor = Math.max(1.3, easeFactor + 0.1 - (1 - quality) * (0.08 + (1 - quality) * 0.02));
  }
  const dueDate = new Date(now);
  dueDate.setDate(dueDate.getDate() + interval);
  return { interval, easeFactor, lapses, totalReviews, dueDate: dueDate.toISOString() };
}
function isDueToday(record) { if (!record?.dueDate) return true; return new Date(record.dueDate) <= new Date(); }
function daysUntilDue(record) { if (!record?.dueDate) return 0; return Math.max(0, Math.ceil((new Date(record.dueDate) - new Date()) / 86400000)); }

// ── CONSTANTS ─────────────────────────────────────────────────────────────────
const DIFFICULTY_COLORS = {
  B2: { bg:"rgba(100,180,100,0.08)", border:"rgba(100,180,100,0.3)", text:"#78c878" },
  C1: { bg:"rgba(80,160,220,0.08)", border:"rgba(80,160,220,0.3)", text:"#6ab0e0" },
  C2: { bg:"rgba(201,169,110,0.08)", border:"rgba(201,169,110,0.3)", text:"#c9a96e" },
};
const TASK_TYPES = [
  { id:"open_cloze", label:"Open Cloze" },
  { id:"word_formation", label:"Word Formation" },
  { id:"key_word_transformation", label:"Key Word" },
  { id:"multiple_choice_cloze", label:"Multiple Choice" },
];
const WRITING_TYPES = [
  { id:"essay", label:"Essay" },
  { id:"article", label:"Article" },
  { id:"report", label:"Report" },
  { id:"review", label:"Review" },
];

const UOE_SYSTEM = `You are a Cambridge CPE Use of English examiner. Generate exercises at mixed difficulty: mostly C1 level with some B2 and some C2 items. Vocabulary and grammar should be genuinely challenging — upper-intermediate to advanced structures, collocations, and idiomatic expressions. Avoid trivially easy items.

CRITICAL: Respond ONLY with raw valid JSON. No markdown, no backticks, no explanation before or after.

Rules:
- The answer must be completely unambiguous
- For MULTIPLE CHOICE: the "answer" field must be the LETTER (A, B, C, or D), not the word itself
- For KEY WORD TRANSFORMATION: candidate fills 3–8 words INCLUDING the key word (unchanged)
- VARIETY IS ESSENTIAL: every exercise must use a completely different sentence, topic, grammar point, and vocabulary area.

JSON format:
{
  "task_type": "open_cloze | word_formation | key_word_transformation | multiple_choice_cloze",
  "difficulty": "B2 | C1 | C2",
  "instructions": "Short clear instruction",
  "sentence": "Sentence with _____ gap (for open_cloze, word_formation, multiple_choice_cloze only)",
  "original_sentence": "Full original sentence (key_word_transformation only)",
  "sentence_start": "Part before the gap (key_word_transformation only)",
  "sentence_end": "Part after the gap (key_word_transformation only)",
  "base_word": "BASE (word_formation only, in caps)",
  "key_word": "KEYWORD (key_word_transformation only, in caps)",
  "options": { "A": "word1", "B": "word2", "C": "word3", "D": "word4" },
  "answer": "for MC: the correct LETTER (A/B/C/D); for others: the exact word or phrase",
  "explanation": "Why this is correct — grammar rule or vocabulary note.",
  "distractor_notes": "Why the wrong answers don't work."
}`;

const WRITING_SYSTEM = `You are a Cambridge CPE writing examiner and coach.
Respond ONLY with raw valid JSON. No markdown, no backticks.

For prompts:
{
  "task_type": "essay | article | report | review",
  "difficulty": "C1",
  "instructions": "Full CPE-style prompt with context and task (3-4 sentences)",
  "word_count": "240-280",
  "tip": "One practical C1-C2 tip for this task type"
}

For feedback:
{
  "score": 1-5,
  "band": "Excellent | Good | Adequate | Inadequate | Poor",
  "content": "...",
  "grammar": "...",
  "vocabulary": "...",
  "organisation": "...",
  "task_achievement": "...",
  "improved_excerpt": "Rewrite of the weakest part at C1-C2 level",
  "overall_tip": "The single most important thing to improve"
}`;

const VOCAB_SYSTEM = `You are a vocabulary exercise generator for Cambridge C2 Proficiency (CPE) exam preparation.
Given a list of English words or phrases, generate exercise data for each one.
Respond ONLY with a raw JSON array. No markdown, no backticks, no explanation before or after.

For each word/phrase, return an object with this exact structure:
{
  "word": "the exact word or phrase as given",
  "definition": "clear, precise definition in 1-2 sentences, C2 level",
  "part_of_speech": "noun | verb | adjective | adverb | phrase | idiom | collocation",
  "register": "formal | neutral | informal | literary",
  "synonyms": ["synonym1", "synonym2", "synonym3"],
  "example": "A natural, contextually rich sentence that uses the word, with the word itself replaced by exactly: _____",
  "distractors": ["plausible_wrong_word1", "plausible_wrong_word2", "plausible_wrong_word3"]
}

Rules for distractors: real English words/phrases that are semantically related or easily confused with the target word but clearly wrong in context. Same difficulty level (C1-C2).
Rules for example: the blank must be exactly _____ (five underscores). Sentence should make the answer inferable from context but not trivially obvious.`;

// ── API CALL ──────────────────────────────────────────────────────────────────
async function callClaude(systemPrompt, userMessage, apiKey) {
  const res = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
    body: JSON.stringify({ model: "claude-sonnet-4-5", max_tokens: 4000, system: systemPrompt, messages: [{ role: "user", content: userMessage }] }),
  });
  if (!res.ok) { const t = await res.text(); throw new Error(`API ${res.status}: ${t.slice(0,200)}`); }
  const data = await res.json();
  const text = (data.content || []).map(b => b.text || "").join("");
  try { return JSON.parse(text.replace(/```json|```/g, "").trim()); }
  catch { throw new Error("Parse error: " + text.slice(0, 200)); }
}

async function fetchBatch(taskType, apiKey) {
  const res = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
    body: JSON.stringify({ model: "claude-sonnet-4-5", max_tokens: 4000, system: UOE_SYSTEM, messages: [{ role: "user", content: `Generate EXACTLY 5 different ${taskType} exercises in a JSON array. Each must test a completely different grammar point, vocabulary area, and use a different sentence topic. No repetition. Difficulty: mix of B2, C1, C2 — mostly C1. Return ONLY a raw JSON array: [ {...}, {...}, {...}, {...}, {...} ]` }] }),
  });
  if (!res.ok) { const t = await res.text(); throw new Error(`API ${res.status}: ${t.slice(0,200)}`); }
  const data = await res.json();
  const text = (data.content || []).map(b => b.text || "").join("");
  const cleaned = text.replace(/```json|```/g, "").trim();
  try { const parsed = JSON.parse(cleaned); return Array.isArray(parsed) ? parsed : [parsed]; }
  catch { throw new Error("Batch parse error: " + cleaned.slice(0, 200)); }
}

async function fetchVocabBatch(batch, apiKey) {
  const res = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
    body: JSON.stringify({ model: "claude-sonnet-4-5", max_tokens: 4000, system: VOCAB_SYSTEM, messages: [{ role: "user", content: `Generate exercise data for these ${batch.length} words/phrases: ${batch.join(", ")}. Return a JSON array with exactly ${batch.length} objects in the same order.` }] }),
  });
  if (!res.ok) throw new Error(`API ${res.status}`);
  const data = await res.json();
  const text = (data.content || []).map(b => b.text || "").join("");
  return JSON.parse(text.replace(/```json|```/g, "").trim());
}

// ── SHARED UI ─────────────────────────────────────────────────────────────────
function Spinner({ text }) {
  return (
    <div style={{ textAlign:"center", padding:"60px 0", color:"#7a6e5f" }}>
      <div style={{ fontSize:28, marginBottom:16, display:"inline-block", animation:"spin 1.2s linear infinite" }}>⟳</div>
      <div style={{ fontFamily:"monospace", fontSize:12, letterSpacing:2 }}>{text}</div>
    </div>
  );
}
function ErrorBox({ msg, onRetry }) {
  return (
    <div style={{ textAlign:"center", padding:"40px 20px" }}>
      <div style={{ fontSize:28, marginBottom:12 }}>⚠️</div>
      <div style={{ fontSize:12, color:"#c86e6e", fontFamily:"monospace", marginBottom:20, maxWidth:480, margin:"0 auto 20px", lineHeight:1.6 }}>{msg}</div>
      {onRetry && <button onClick={onRetry} style={{ background:"rgba(201,169,110,0.1)", border:"1px solid rgba(201,169,110,0.3)", borderRadius:8, padding:"10px 24px", cursor:"pointer", color:"#c9a96e", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>TRY AGAIN</button>}
    </div>
  );
}

// ── API KEY SCREEN ────────────────────────────────────────────────────────────
function ApiKeyScreen({ onSave }) {
  const [val, setVal] = useState("");
  return (
    <div style={{ minHeight:"100vh", display:"flex", alignItems:"center", justifyContent:"center", background:"linear-gradient(160deg,#0c0c14,#111118)", padding:24 }}>
      <div style={{ width:"100%", maxWidth:440 }}>
        <div style={{ marginBottom:32, textAlign:"center" }}>
          <div style={{ fontSize:9, letterSpacing:3, color:"#7a6e5f", fontFamily:"monospace", marginBottom:8 }}>CAMBRIDGE C2</div>
          <div style={{ fontSize:22, fontWeight:700, color:"#f0e8d8" }}>CPE <span style={{ color:"#c9a96e" }}>Practice</span></div>
        </div>
        <div style={{ background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:12, padding:28 }}>
          <div style={{ fontSize:13, color:"#9a8e7e", marginBottom:20, lineHeight:1.8 }}>
            To use this app you need an Anthropic API key. It's saved only on this device.
            <br/><br/>
            Get one free at <span style={{ color:"#c9a96e" }}>console.anthropic.com</span> → API Keys.
          </div>
          <input
            value={val} onChange={e => setVal(e.target.value)}
            placeholder="sk-ant-..."
            type="password"
            style={{ width:"100%", background:"rgba(255,255,255,0.04)", border:"1px solid #2a2a3e", borderRadius:8, padding:"13px 16px", color:"#e8e0d0", fontSize:14, fontFamily:"monospace", outline:"none", marginBottom:14 }}
          />
          <button onClick={() => { if (val.trim()) onSave(val.trim()); }}
            disabled={!val.trim()}
            style={{ width:"100%", background:val.trim()?"rgba(201,169,110,0.14)":"rgba(255,255,255,0.03)", border:val.trim()?"1px solid rgba(201,169,110,0.4)":"1px solid #2a2a3e", borderRadius:8, padding:"13px", cursor:val.trim()?"pointer":"not-allowed", color:val.trim()?"#c9a96e":"#7a6e5f", fontSize:12, fontFamily:"monospace", letterSpacing:3 }}>
            SAVE & CONTINUE →
          </button>
        </div>
      </div>
    </div>
  );
}

// ── UOE CARD ──────────────────────────────────────────────────────────────────
function UoECard({ exercise, onNext }) {
  const [submitted, setSubmitted] = useState(null);
  const [textVal, setTextVal] = useState("");
  const diff = DIFFICULTY_COLORS[exercise.difficulty] || DIFFICULTY_COLORS.C1;
  const isMC = exercise.task_type === "multiple_choice_cloze";
  const isKWT = exercise.task_type === "key_word_transformation";
  const normalize = s => (s||"").toLowerCase().trim().replace(/\s+/g," ").replace(/[\u2018\u2019]/g,"'");
  const checkAnswer = (raw) => {
    const correct = normalize(raw) === normalize(exercise.answer);
    const displayAnswer = isMC ? (exercise.options?.[raw] || raw) : raw;
    setSubmitted({ raw, displayAnswer, correct });
  };
  const renderGap = () => {
    const s = exercise.sentence || "";
    const parts = s.split("_____");
    if (parts.length < 2) return <span>{s}</span>;
    return <span>{parts[0]}<span style={{ display:"inline-block", minWidth:90, borderBottom:submitted?"none":"2px solid rgba(201,169,110,0.5)", color:submitted?(submitted.correct?"#6dc87e":"#c86e6e"):"transparent", fontWeight:700, margin:"0 4px", textAlign:"center" }}>{submitted?submitted.displayAnswer:"______"}</span>{parts[1]}</span>;
  };
  return (
    <div style={{ animation:"fadeIn 0.3s ease" }}>
      <div style={{ display:"flex", gap:8, marginBottom:18 }}>
        <span style={{ background:diff.bg, border:`1px solid ${diff.border}`, borderRadius:4, padding:"3px 10px", fontSize:10, letterSpacing:2, color:diff.text, fontFamily:"monospace", textTransform:"uppercase" }}>{exercise.difficulty}</span>
        <span style={{ background:"rgba(255,255,255,0.04)", border:"1px solid #2a2a3e", borderRadius:4, padding:"3px 10px", fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", textTransform:"uppercase" }}>
          {TASK_TYPES.find(t=>t.id===exercise.task_type)?.label||exercise.task_type}
        </span>
      </div>
      <p style={{ margin:"0 0 18px", fontSize:13, color:"#9a8e7e", fontStyle:"italic", lineHeight:1.6 }}>{exercise.instructions}</p>
      {isKWT && (
        <div style={{ marginBottom:20 }}>
          <div style={{ background:"rgba(255,255,255,0.02)", border:"1px solid #2a2a3e", borderRadius:8, padding:"16px 22px", marginBottom:12 }}>
            <div style={{ fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", textTransform:"uppercase", marginBottom:8 }}>Original sentence</div>
            <div style={{ fontSize:16, lineHeight:1.8, color:"#e8e0d0" }}>{exercise.original_sentence}</div>
          </div>
          <div style={{ marginBottom:12, display:"flex", alignItems:"center", gap:10, flexWrap:"wrap" }}>
            <span style={{ fontSize:11, color:"#7a6e5f", fontFamily:"monospace", letterSpacing:1 }}>KEY WORD</span>
            <span style={{ padding:"4px 14px", background:"rgba(201,169,110,0.1)", border:"1px solid rgba(201,169,110,0.3)", borderRadius:4, color:"#c9a96e", fontFamily:"monospace", fontWeight:700, letterSpacing:2, fontSize:14 }}>{exercise.key_word}</span>
            <span style={{ fontSize:11, color:"#7a6e5f", fontFamily:"monospace" }}>3–8 words · do not modify the key word</span>
          </div>
          <div style={{ background:"rgba(255,255,255,0.025)", border:"1px solid #2a2a3e", borderLeft:"3px solid rgba(201,169,110,0.35)", borderRadius:8, padding:"18px 22px", fontSize:16, lineHeight:2, color:"#e8e0d0" }}>
            {exercise.sentence_start}{" "}
            <span style={{ display:"inline-block", minWidth:160, borderBottom:submitted?"none":"2px dashed rgba(201,169,110,0.5)", color:submitted?(submitted.correct?"#6dc87e":"#c86e6e"):"transparent", fontWeight:700, margin:"0 6px", textAlign:"center", fontStyle:"italic" }}>
              {submitted?submitted.displayAnswer:"_ _ _ _ _ _ _ _"}
            </span>
            {" "}{exercise.sentence_end}
          </div>
        </div>
      )}
      {!isKWT && (
        <div style={{ background:"rgba(255,255,255,0.025)", border:"1px solid #2a2a3e", borderLeft:"3px solid rgba(201,169,110,0.35)", borderRadius:8, padding:"22px 26px", marginBottom:16, fontSize:17, lineHeight:1.9, color:"#e8e0d0" }}>
          {renderGap()}
        </div>
      )}
      {exercise.base_word && (
        <div style={{ marginBottom:16, display:"flex", alignItems:"center", gap:10 }}>
          <span style={{ fontSize:11, color:"#7a6e5f", fontFamily:"monospace", letterSpacing:1 }}>BASE WORD</span>
          <span style={{ padding:"4px 14px", background:"rgba(201,169,110,0.1)", border:"1px solid rgba(201,169,110,0.3)", borderRadius:4, color:"#c9a96e", fontFamily:"monospace", fontWeight:700, letterSpacing:2, fontSize:14 }}>{exercise.base_word}</span>
        </div>
      )}
      {!submitted && (
        isMC ? (
          <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:10, marginBottom:16 }}>
            {Object.entries(exercise.options||{}).map(([letter,word]) => (
              <button key={letter} onClick={() => checkAnswer(letter)}
                style={{ background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:8, padding:"12px 16px", cursor:"pointer", color:"#e8e0d0", fontSize:14, textAlign:"left", display:"flex", gap:10, alignItems:"center" }}>
                <span style={{ color:"#c9a96e", fontFamily:"monospace", fontWeight:700, minWidth:20 }}>{letter}</span>
                <span>{word}</span>
              </button>
            ))}
          </div>
        ) : (
          <div style={{ display:"flex", gap:10 }}>
            <input value={textVal} onChange={e => setTextVal(e.target.value)}
              onKeyDown={e => e.key==="Enter" && textVal.trim() && checkAnswer(textVal.trim())}
              placeholder={isKWT?"Enter 3–8 words including the key word...":exercise.task_type==="word_formation"?"Enter transformed word...":"Enter one word..."}
              autoFocus
              style={{ flex:1, background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:8, padding:"13px 18px", color:"#e8e0d0", fontSize:15, outline:"none" }}
            />
            <button onClick={() => textVal.trim() && checkAnswer(textVal.trim())}
              style={{ background:"rgba(201,169,110,0.12)", border:"1px solid rgba(201,169,110,0.35)", borderRadius:8, padding:"13px 22px", cursor:"pointer", color:"#c9a96e", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>CHECK</button>
          </div>
        )
      )}
      {submitted && (
        <div style={{ animation:"fadeIn 0.25s ease" }}>
          <div style={{ background:submitted.correct?"rgba(80,200,120,0.06)":"rgba(200,80,80,0.06)", border:`1px solid ${submitted.correct?"rgba(80,200,120,0.25)":"rgba(200,80,80,0.25)"}`, borderRadius:8, padding:"18px 22px", marginBottom:14 }}>
            <div style={{ fontSize:12, fontFamily:"monospace", letterSpacing:2, color:submitted.correct?"#6dc87e":"#c86e6e", marginBottom:8 }}>{submitted.correct?"✓  CORRECT":"✗  INCORRECT"}</div>
            <div><span style={{ fontSize:12, color:"#7a6e5f", fontFamily:"monospace" }}>ANSWER: </span><span style={{ color:"#c9a96e", fontWeight:700, fontSize:15 }}>{isMC?`${exercise.answer} — ${exercise.options?.[exercise.answer]}`:exercise.answer}</span></div>
          </div>
          <div style={{ marginBottom:12, padding:"16px 20px", background:"rgba(255,255,255,0.02)", border:"1px solid #2a2a3e", borderRadius:8 }}>
            <div style={{ fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", textTransform:"uppercase", marginBottom:8 }}>Explanation</div>
            <div style={{ fontSize:13.5, color:"#c0b49e", lineHeight:1.75 }}>{exercise.explanation}</div>
          </div>
          {exercise.distractor_notes && (
            <div style={{ marginBottom:16, padding:"12px 18px", background:"rgba(100,120,255,0.04)", border:"1px solid rgba(100,120,255,0.15)", borderRadius:6, fontSize:12, color:"#8888cc", fontFamily:"monospace", lineHeight:1.6 }}>⚠ {exercise.distractor_notes}</div>
          )}
          <button onClick={() => onNext(submitted.correct)}
            style={{ background:"rgba(201,169,110,0.1)", border:"1px solid rgba(201,169,110,0.3)", borderRadius:8, padding:"12px 28px", cursor:"pointer", color:"#c9a96e", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>
            NEXT EXERCISE →
          </button>
        </div>
      )}
    </div>
  );
}

// ── WRITING SECTION ───────────────────────────────────────────────────────────
function WritingSection({ apiKey }) {
  const [writingType, setWritingType] = useState("random");
  const [prompt, setPrompt] = useState(null);
  const [userText, setUserText] = useState("");
  const [feedback, setFeedback] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const wordCount = userText.trim().split(/\s+/).filter(Boolean).length;

  const generatePrompt = async () => {
    setLoading(true); setPrompt(null); setFeedback(null); setUserText(""); setError(null);
    const types = WRITING_TYPES.map(t=>t.id);
    const type = writingType==="random" ? types[Math.floor(Math.random()*types.length)] : writingType;
    try { setPrompt(await callClaude(WRITING_SYSTEM, `Generate a CPE ${type} writing prompt at C1 level.`, apiKey)); }
    catch(e) { setError(e.message); }
    setLoading(false);
  };

  const getFeedback = async () => {
    if (!userText.trim() || !prompt) return;
    setLoading(true); setError(null);
    try { setFeedback(await callClaude(WRITING_SYSTEM, `Give CPE examiner feedback on this ${prompt.task_type}.\n\nPrompt: ${prompt.instructions}\n\nResponse:\n${userText}`, apiKey)); }
    catch(e) { setError(e.message); }
    setLoading(false);
  };

  return (
    <div>
      <div style={{ display:"flex", gap:6, marginBottom:28, flexWrap:"wrap" }}>
        {[{ id:"random", label:"ALL TYPES" }, ...WRITING_TYPES.map(t=>({ id:t.id, label:t.label.toUpperCase() }))].map(t => (
          <button key={t.id} onClick={() => setWritingType(t.id)}
            style={{ background:writingType===t.id?"rgba(201,169,110,0.14)":"rgba(255,255,255,0.03)", border:writingType===t.id?"1px solid rgba(201,169,110,0.4)":"1px solid #2a2a3e", borderRadius:6, padding:"5px 10px", cursor:"pointer", color:writingType===t.id?"#c9a96e":"#7a6e5f", fontSize:10, fontFamily:"monospace", letterSpacing:0.5, whiteSpace:"nowrap" }}>
            {t.label}
          </button>
        ))}
      </div>
      {!prompt && !loading && !error && (
        <div style={{ textAlign:"center", padding:"60px 0" }}>
          <div style={{ fontSize:48, marginBottom:20 }}>✍️</div>
          <div style={{ fontSize:15, color:"#9a8e7e", marginBottom:8 }}>Ready to practise Writing?</div>
          <div style={{ fontSize:12, color:"#7a6e5f", fontFamily:"monospace", marginBottom:32 }}>C1 prompts · Examiner-style feedback</div>
          <button onClick={generatePrompt} style={{ background:"rgba(201,169,110,0.12)", border:"1px solid rgba(201,169,110,0.4)", borderRadius:10, padding:"14px 36px", cursor:"pointer", color:"#c9a96e", fontSize:13, fontFamily:"monospace", letterSpacing:3 }}>GET A PROMPT</button>
        </div>
      )}
      {loading && <Spinner text="WORKING..." />}
      {error && <ErrorBox msg={error} onRetry={generatePrompt} />}
      {prompt && !loading && (
        <div style={{ animation:"fadeIn 0.3s ease" }}>
          <div style={{ display:"flex", gap:8, marginBottom:18 }}>
            <span style={{ background:"rgba(80,160,220,0.08)", border:"1px solid rgba(80,160,220,0.3)", borderRadius:4, padding:"3px 10px", fontSize:10, letterSpacing:2, color:"#6ab0e0", fontFamily:"monospace", textTransform:"uppercase" }}>C1</span>
            <span style={{ background:"rgba(255,255,255,0.04)", border:"1px solid #2a2a3e", borderRadius:4, padding:"3px 10px", fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", textTransform:"uppercase" }}>{prompt.task_type}</span>
            <span style={{ background:"rgba(255,255,255,0.04)", border:"1px solid #2a2a3e", borderRadius:4, padding:"3px 10px", fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", textTransform:"uppercase" }}>{prompt.word_count} words</span>
          </div>
          <div style={{ background:"rgba(255,255,255,0.025)", border:"1px solid #2a2a3e", borderLeft:"3px solid rgba(201,169,110,0.35)", borderRadius:8, padding:"22px 26px", marginBottom:16, fontSize:15, lineHeight:1.9, color:"#e8e0d0" }}>{prompt.instructions}</div>
          {prompt.tip && <div style={{ marginBottom:20, padding:"12px 18px", background:"rgba(100,120,255,0.04)", border:"1px solid rgba(100,120,255,0.15)", borderRadius:6, fontSize:12, color:"#8888cc", fontFamily:"monospace", lineHeight:1.6 }}>💡 {prompt.tip}</div>}
          {!feedback && (
            <div>
              <textarea value={userText} onChange={e => setUserText(e.target.value)} placeholder={`Write your ${prompt.task_type} here...`}
                style={{ width:"100%", minHeight:240, background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:8, padding:"16px", color:"#e8e0d0", fontSize:15, lineHeight:1.8, resize:"vertical", outline:"none" }}
              />
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginTop:10 }}>
                <span style={{ fontSize:12, color:wordCount>280?"#c86e6e":wordCount>=240?"#6dc87e":"#7a6e5f", fontFamily:"monospace" }}>{wordCount} / 240–280 words</span>
                <div style={{ display:"flex", gap:8 }}>
                  <button onClick={generatePrompt} style={{ background:"transparent", border:"1px solid #2a2a3e", borderRadius:8, padding:"10px 18px", cursor:"pointer", color:"#7a6e5f", fontSize:11, fontFamily:"monospace", letterSpacing:1 }}>NEW PROMPT</button>
                  <button onClick={getFeedback} disabled={!userText.trim()}
                    style={{ background:userText.trim()?"rgba(201,169,110,0.12)":"rgba(255,255,255,0.03)", border:userText.trim()?"1px solid rgba(201,169,110,0.4)":"1px solid #2a2a3e", borderRadius:8, padding:"10px 22px", cursor:userText.trim()?"pointer":"not-allowed", color:userText.trim()?"#c9a96e":"#7a6e5f", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>
                    GET FEEDBACK
                  </button>
                </div>
              </div>
            </div>
          )}
          {feedback && (
            <div style={{ border:"1px solid #2a2a3e", borderRadius:8, overflow:"hidden" }}>
              <div style={{ background:"rgba(201,169,110,0.08)", borderBottom:"1px solid #2a2a3e", padding:"16px 24px", display:"flex", alignItems:"center", justifyContent:"space-between" }}>
                <span style={{ fontSize:11, letterSpacing:2, fontFamily:"monospace", color:"#c9a96e", textTransform:"uppercase" }}>Examiner Feedback</span>
                <span style={{ fontSize:20, color:"#c9a96e", fontWeight:700 }}>{feedback.score}/5 — {feedback.band}</span>
              </div>
              <div style={{ padding:24 }}>
                {[["Content",feedback.content],["Grammar",feedback.grammar],["Vocabulary",feedback.vocabulary],["Organisation",feedback.organisation],["Task Achievement",feedback.task_achievement]].map(([label,val]) => val && (
                  <div key={label} style={{ marginBottom:18 }}>
                    <div style={{ fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", textTransform:"uppercase", marginBottom:6 }}>{label}</div>
                    <div style={{ fontSize:14, color:"#c0b49e", lineHeight:1.75 }}>{val}</div>
                  </div>
                ))}
                {feedback.improved_excerpt && (
                  <div style={{ marginTop:8, padding:"16px 20px", background:"rgba(255,255,255,0.02)", border:"1px solid #2a2a3e", borderLeft:"3px solid rgba(201,169,110,0.4)", borderRadius:6 }}>
                    <div style={{ fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", textTransform:"uppercase", marginBottom:8 }}>Improved Excerpt</div>
                    <div style={{ fontSize:14, color:"#e8e0d0", lineHeight:1.8, fontStyle:"italic" }}>{feedback.improved_excerpt}</div>
                  </div>
                )}
                {feedback.overall_tip && (
                  <div style={{ marginTop:16, padding:"12px 18px", background:"rgba(100,120,255,0.04)", border:"1px solid rgba(100,120,255,0.15)", borderRadius:6, fontSize:12, color:"#8888cc", fontFamily:"monospace", lineHeight:1.6 }}>💡 {feedback.overall_tip}</div>
                )}
                <button onClick={generatePrompt} style={{ marginTop:20, background:"rgba(201,169,110,0.1)", border:"1px solid rgba(201,169,110,0.3)", borderRadius:6, padding:"10px 24px", cursor:"pointer", color:"#c9a96e", fontSize:12, fontFamily:"monospace", letterSpacing:1 }}>NEW PROMPT →</button>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// ── VOCABULARY SECTION ────────────────────────────────────────────────────────
function VocabularySection({ apiKey }) {
  const [wordData, setWordData] = useState(() => LS.get("cpe-vocab-words", {}));
  const [srsData, setSrsData] = useState(() => LS.get("cpe-vocab-srs", {}));
  const [view, setView] = useState("dashboard");
  const [addInput, setAddInput] = useState("");
  const [loadingProgress, setLoadingProgress] = useState({ done:0, total:0 });
  const [queue, setQueue] = useState([]);
  const [currentIdx, setCurrentIdx] = useState(0);
  const [submitted, setSubmitted] = useState(null);
  const [textVal, setTextVal] = useState("");
  const [sessionScore, setSessionScore] = useState({ correct:0, total:0 });
  const [sessionSrsUpdates, setSessionSrsUpdates] = useState({});
  const [exportText, setExportText] = useState(null);
  const [importOpen, setImportOpen] = useState(false);
  const [importText, setImportText] = useState("");
  const [importError, setImportError] = useState("");

  const saveWords = (data) => { setWordData(data); LS.set("cpe-vocab-words", data); };
  const saveSrs = (data) => { setSrsData(data); LS.set("cpe-vocab-srs", data); };

  const parseWords = (text) => [...new Set(text.split(/[\n,;]+/).map(w=>w.trim()).filter(Boolean))];

  const handleExport = () => {
    setExportText(JSON.stringify({ wordData, srsData }, null, 2));
  };

  const handleImport = (raw) => {
    try {
      const parsed = JSON.parse(raw);
      if (!parsed.wordData) { setImportError("Invalid backup — no wordData found."); return; }
      saveWords(parsed.wordData || {});
      saveSrs(parsed.srsData || {});
      setImportOpen(false); setImportText(""); setImportError("");
    } catch { setImportError("Could not parse. Make sure you copied the full backup text."); }
  };

  const handleAddWords = async () => {
    const newWords = parseWords(addInput).filter(w => !wordData[w]);
    if (!newWords.length) { setAddInput(""); setView("dashboard"); return; }
    setView("loading-add");
    const batches = [];
    for (let i = 0; i < newWords.length; i += 5) batches.push(newWords.slice(i, i+5));
    setLoadingProgress({ done:0, total:batches.length });
    const newData = { ...wordData };
    for (let i = 0; i < batches.length; i++) {
      try {
        const items = await fetchVocabBatch(batches[i], apiKey);
        items.forEach(item => { if (item?.word) newData[item.word] = item; });
      } catch {
        for (const word of batches[i]) {
          try { const [item] = await fetchVocabBatch([word], apiKey); if (item?.word) newData[item.word] = item; } catch {}
        }
      }
      setLoadingProgress(p => ({ ...p, done:i+1 }));
    }
    saveWords(newData);
    setAddInput(""); setView("dashboard");
  };

  const buildQueue = (allData, allSrs) => {
    const dueWords = shuffleArray(Object.keys(allData).filter(w => isDueToday(allSrs[w])));
    const types = ['mc_def','fillblank','reverse'];
    return dueWords.map(word => {
      const d = allData[word];
      const type = types[Math.floor(Math.random()*types.length)];
      let options = null, answer = null;
      if (type==='mc_def') { const r=buildMCOptions_def(word,d.definition,allData); options=r.options; answer=r.answer; }
      else if (type==='fillblank') { const r=buildMCOptions_fill(d.word,d.distractors); options=r.options; answer=r.answer; }
      return { word, type, options, answer };
    });
  };

  const startSession = () => {
    const q = buildQueue(wordData, srsData);
    if (!q.length) return;
    setQueue(q); setCurrentIdx(0); setSubmitted(null); setTextVal("");
    setSessionScore({ correct:0, total:0 }); setSessionSrsUpdates({});
    setView("session");
  };

  const normalize = s => (s||"").toLowerCase().trim().replace(/\s+/g," ").replace(/[\u2018\u2019']/g,"'");
  const currentCard = queue[currentIdx];
  const currentData = currentCard ? wordData[currentCard.word] : null;

  const checkAnswer = (userAnswer) => {
    if (!currentData || !currentCard) return;
    const correct = currentCard.type==='reverse'
      ? normalize(userAnswer)===normalize(currentCard.word)
      : userAnswer===currentCard.answer;
    setSessionScore(s => ({ correct:s.correct+(correct?1:0), total:s.total+1 }));
    setSubmitted({ correct, userAnswer });
  };

  const handleNext = () => {
    const word = currentCard.word;
    const isCorrect = submitted?.correct;
    const updated = sm2Update(srsData[word], isCorrect?1:0);
    const newSrsUpdates = { ...sessionSrsUpdates, [word]:updated };
    setSessionSrsUpdates(newSrsUpdates);
    // Persist SRS immediately (localStorage is reliable here)
    saveSrs({ ...srsData, ...newSrsUpdates });
    setSubmitted(null); setTextVal("");
    let newQueue = [...queue];
    if (!isCorrect) {
      const types = ['mc_def','fillblank','reverse'];
      const reType = types.filter(t=>t!==currentCard.type)[Math.floor(Math.random()*2)];
      const d = wordData[word];
      let opts=null, ans=null;
      if (reType==='mc_def') { const r=buildMCOptions_def(word,d.definition,wordData); opts=r.options; ans=r.answer; }
      else if (reType==='fillblank') { const r=buildMCOptions_fill(d.word,d.distractors); opts=r.options; ans=r.answer; }
      newQueue.splice(Math.min(currentIdx+3,newQueue.length),0,{ word,type:reType,options:opts,answer:ans });
      setQueue(newQueue);
    }
    const next = currentIdx+1;
    if (next>=newQueue.length) setView("complete");
    else setCurrentIdx(next);
  };

  const allWords = Object.keys(wordData);
  const dueWords = allWords.filter(w => isDueToday(srsData[w]));
  const learnedWords = allWords.filter(w => srsData[w]?.totalReviews>0);
  const strugglingWords = allWords.filter(w => (srsData[w]?.lapses||0)>=2);

  // LOADING ADD
  if (view==="loading-add") {
    const pct = loadingProgress.total>0 ? Math.round((loadingProgress.done/loadingProgress.total)*100) : 0;
    return (
      <div style={{ textAlign:"center", padding:"60px 0" }}>
        <div style={{ fontSize:28, marginBottom:16, display:"inline-block", animation:"spin 1.2s linear infinite" }}>⟳</div>
        <div style={{ fontFamily:"monospace", fontSize:12, letterSpacing:2, color:"#7a6e5f", marginBottom:24 }}>GENERATING EXERCISE DATA...</div>
        <div style={{ maxWidth:280, margin:"0 auto" }}>
          <div style={{ background:"#1e1e2e", borderRadius:4, height:4, overflow:"hidden" }}>
            <div style={{ background:"#c9a96e", height:"100%", width:`${pct}%`, transition:"width 0.4s ease", borderRadius:4 }} />
          </div>
          <div style={{ fontSize:11, color:"#7a6e5f", fontFamily:"monospace", marginTop:10 }}>{loadingProgress.done}/{loadingProgress.total} batches · {pct}%</div>
        </div>
      </div>
    );
  }

  // ADD WORDS
  if (view==="add") {
    const newWords = parseWords(addInput).filter(w => !wordData[w]);
    const existing = parseWords(addInput).filter(w => wordData[w]);
    return (
      <div>
        <div style={{ display:"flex", alignItems:"center", gap:12, marginBottom:20 }}>
          <button onClick={() => { setAddInput(""); setView("dashboard"); }} style={{ background:"transparent", border:"none", color:"#7a6e5f", cursor:"pointer", fontSize:18, padding:0 }}>←</button>
          <span style={{ fontSize:13, color:"#c9a96e", fontFamily:"monospace", letterSpacing:2 }}>ADD WORDS</span>
        </div>
        <textarea value={addInput} onChange={e => setAddInput(e.target.value)}
          placeholder={"ebullient\npernicious\nequivocate\n\nOne per line, or comma-separated."}
          autoFocus
          style={{ width:"100%", minHeight:200, background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:8, padding:"16px", color:"#e8e0d0", fontSize:15, lineHeight:1.8, resize:"vertical", outline:"none" }}
        />
        <div style={{ marginTop:10, marginBottom:16, minHeight:20 }}>
          {newWords.length>0 && <span style={{ fontSize:12, color:"#6dc87e", fontFamily:"monospace" }}>+ {newWords.length} new word{newWords.length!==1?"s":""}</span>}
          {existing.length>0 && <span style={{ fontSize:12, color:"#7a6e5f", fontFamily:"monospace", marginLeft:14 }}>{existing.length} already in list</span>}
        </div>
        <div style={{ display:"flex", gap:10 }}>
          <button onClick={() => { setAddInput(""); setView("dashboard"); }} style={{ background:"transparent", border:"1px solid #2a2a3e", borderRadius:8, padding:"10px 22px", cursor:"pointer", color:"#7a6e5f", fontSize:11, fontFamily:"monospace", letterSpacing:1 }}>CANCEL</button>
          <button onClick={handleAddWords} disabled={newWords.length===0}
            style={{ background:newWords.length>0?"rgba(201,169,110,0.12)":"rgba(255,255,255,0.03)", border:newWords.length>0?"1px solid rgba(201,169,110,0.4)":"1px solid #2a2a3e", borderRadius:10, padding:"10px 28px", cursor:newWords.length>0?"pointer":"not-allowed", color:newWords.length>0?"#c9a96e":"#7a6e5f", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>
            ADD & GENERATE →
          </button>
        </div>
      </div>
    );
  }

  // COMPLETE
  if (view==="complete") {
    const reviewedCount = Object.keys(sessionSrsUpdates).length;
    const pct = sessionScore.total ? Math.round((sessionScore.correct/sessionScore.total)*100) : 0;
    return (
      <div style={{ textAlign:"center", padding:"48px 20px", animation:"fadeIn 0.3s ease" }}>
        <div style={{ fontSize:40, marginBottom:16 }}>🎓</div>
        <div style={{ fontSize:18, color:"#f0e8d8", fontWeight:700, marginBottom:8 }}>Session Complete</div>
        <div style={{ fontSize:13, color:"#9a8e7e", marginBottom:28 }}>{reviewedCount} words reviewed · progress saved</div>
        <div style={{ display:"flex", gap:16, justifyContent:"center", marginBottom:32, flexWrap:"wrap" }}>
          {[{ label:"CORRECT",val:`${sessionScore.correct}/${sessionScore.total}`,color:"#6dc87e" },{ label:"ACCURACY",val:`${pct}%`,color:"#c9a96e" },{ label:"REVIEWED",val:`${reviewedCount}`,color:"#6ab0e0" }].map(({ label,val,color }) => (
            <div key={label} style={{ background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:8, padding:"16px 22px", minWidth:80 }}>
              <div style={{ fontSize:9, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", marginBottom:6 }}>{label}</div>
              <div style={{ fontSize:20, color, fontWeight:700, fontFamily:"monospace" }}>{val}</div>
            </div>
          ))}
        </div>
        <div style={{ marginBottom:28, padding:"14px 20px", background:"rgba(255,255,255,0.02)", border:"1px solid #2a2a3e", borderRadius:8, fontSize:12, color:"#9a8e7e", fontFamily:"monospace" }}>
          {(() => {
            const remaining = Object.keys(srsData).filter(w=>isDueToday(srsData[w])).length;
            if (remaining>0) return `${remaining} more word${remaining!==1?"s":""} still due today`;
            const days = Object.keys(srsData).map(w=>daysUntilDue(srsData[w])).filter(d=>d>0);
            const minDays = days.length ? Math.min(...days) : null;
            return minDays ? `Next review in ${minDays} day${minDays!==1?"s":""}` : "All caught up!";
          })()}
        </div>
        <div style={{ display:"flex", gap:10, justifyContent:"center", flexWrap:"wrap" }}>
          <button onClick={() => setView("dashboard")} style={{ background:"transparent", border:"1px solid #2a2a3e", borderRadius:8, padding:"10px 22px", cursor:"pointer", color:"#7a6e5f", fontSize:11, fontFamily:"monospace", letterSpacing:1 }}>DASHBOARD</button>
          <button onClick={handleExport} style={{ background:"rgba(106,176,224,0.06)", border:"1px solid rgba(106,176,224,0.2)", borderRadius:8, padding:"10px 18px", cursor:"pointer", color:"#6ab0e0", fontSize:11, fontFamily:"monospace", letterSpacing:1 }}>↓ EXPORT BACKUP</button>
          {buildQueue(wordData,srsData).length>0 && <button onClick={startSession} style={{ background:"rgba(201,169,110,0.1)", border:"1px solid rgba(201,169,110,0.3)", borderRadius:8, padding:"10px 24px", cursor:"pointer", color:"#c9a96e", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>CONTINUE →</button>}
        </div>
      </div>
    );
  }

  // DASHBOARD
  if (view==="dashboard") {
    return (
      <div style={{ animation:"fadeIn 0.3s ease" }}>
        {/* Export modal */}
        {exportText && (
          <div style={{ position:"fixed", inset:0, background:"rgba(0,0,0,0.85)", zIndex:100, display:"flex", alignItems:"center", justifyContent:"center", padding:20 }}>
            <div style={{ background:"#111118", border:"1px solid #2a2a3e", borderRadius:12, padding:24, width:"100%", maxWidth:520, display:"flex", flexDirection:"column" }}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:14 }}>
                <span style={{ fontSize:11, letterSpacing:2, color:"#c9a96e", fontFamily:"monospace" }}>EXPORT BACKUP</span>
                <button onClick={() => setExportText(null)} style={{ background:"none", border:"none", color:"#7a6e5f", cursor:"pointer", fontSize:18, padding:0 }}>✕</button>
              </div>
              <div style={{ fontSize:12, color:"#9a8e7e", marginBottom:10, lineHeight:1.6 }}>
                Select all <strong style={{ color:"#c0b49e" }}>(Ctrl+A / Cmd+A)</strong> and copy <strong style={{ color:"#c0b49e" }}>(Ctrl+C / Cmd+C)</strong>. Save anywhere. To restore, use Import.
              </div>
              <textarea readOnly value={exportText}
                ref={el => { if(el) { el.focus(); el.select(); } }}
                style={{ minHeight:200, background:"rgba(255,255,255,0.03)", border:"1px solid rgba(201,169,110,0.3)", borderRadius:8, padding:"12px", color:"#9aae9a", fontSize:11, fontFamily:"monospace", lineHeight:1.5, resize:"vertical", outline:"none" }}
              />
              <div style={{ marginTop:8, fontSize:11, color:"#7a6e5f", fontFamily:"monospace", textAlign:"center" }}>Text is already selected — press Ctrl+C (or Cmd+C)</div>
            </div>
          </div>
        )}
        {/* Import modal */}
        {importOpen && (
          <div style={{ position:"fixed", inset:0, background:"rgba(0,0,0,0.85)", zIndex:100, display:"flex", alignItems:"center", justifyContent:"center", padding:20 }}>
            <div style={{ background:"#111118", border:"1px solid #2a2a3e", borderRadius:12, padding:24, width:"100%", maxWidth:520, display:"flex", flexDirection:"column" }}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:14 }}>
                <span style={{ fontSize:11, letterSpacing:2, color:"#c9a96e", fontFamily:"monospace" }}>IMPORT BACKUP</span>
                <button onClick={() => { setImportOpen(false); setImportText(""); setImportError(""); }} style={{ background:"none", border:"none", color:"#7a6e5f", cursor:"pointer", fontSize:18, padding:0 }}>✕</button>
              </div>
              <div style={{ fontSize:12, color:"#9a8e7e", marginBottom:14 }}>Paste your backup text below, then click Restore.</div>
              <textarea value={importText} onChange={e => { setImportText(e.target.value); setImportError(""); }}
                placeholder='{"wordData":{...},"srsData":{...}}'
                autoFocus
                style={{ minHeight:160, background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:8, padding:"12px", color:"#9aae9a", fontSize:11, fontFamily:"monospace", lineHeight:1.5, resize:"vertical", outline:"none" }}
              />
              {importError && <div style={{ fontSize:11, color:"#c86e6e", fontFamily:"monospace", marginTop:8 }}>{importError}</div>}
              <button onClick={() => handleImport(importText)} disabled={!importText.trim()}
                style={{ marginTop:14, background:importText.trim()?"rgba(201,169,110,0.12)":"rgba(255,255,255,0.03)", border:importText.trim()?"1px solid rgba(201,169,110,0.4)":"1px solid #2a2a3e", borderRadius:8, padding:"12px", cursor:importText.trim()?"pointer":"not-allowed", color:importText.trim()?"#c9a96e":"#7a6e5f", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>
                RESTORE
              </button>
            </div>
          </div>
        )}

        {allWords.length===0 ? (
          <div style={{ textAlign:"center", padding:"60px 20px" }}>
            <div style={{ fontSize:40, marginBottom:16 }}>📚</div>
            <div style={{ fontSize:15, color:"#9a8e7e", marginBottom:8 }}>No words yet</div>
            <div style={{ fontSize:12, color:"#7a6e5f", fontFamily:"monospace", marginBottom:32, lineHeight:1.7 }}>Add your vocabulary list, or restore from a backup.</div>
            <div style={{ display:"flex", gap:10, justifyContent:"center", flexWrap:"wrap" }}>
              <button onClick={() => setView("add")} style={{ background:"rgba(201,169,110,0.12)", border:"1px solid rgba(201,169,110,0.4)", borderRadius:10, padding:"14px 36px", cursor:"pointer", color:"#c9a96e", fontSize:13, fontFamily:"monospace", letterSpacing:3 }}>ADD WORDS</button>
              <button onClick={() => setImportOpen(true)} style={{ background:"rgba(255,255,255,0.04)", border:"1px solid #2a2a3e", borderRadius:10, padding:"14px 24px", cursor:"pointer", color:"#7a6e5f", fontSize:13, fontFamily:"monospace", letterSpacing:2 }}>RESTORE BACKUP</button>
            </div>
          </div>
        ) : (
          <>
            <div style={{ display:"grid", gridTemplateColumns:"repeat(4,1fr)", gap:10, marginBottom:24 }}>
              {[{ label:"TOTAL",val:allWords.length,color:"#c9a96e" },{ label:"DUE TODAY",val:dueWords.length,color:dueWords.length>0?"#c86e6e":"#6dc87e" },{ label:"REVIEWED",val:learnedWords.length,color:"#6dc87e" },{ label:"STRUGGLING",val:strugglingWords.length,color:strugglingWords.length>0?"#c9a96e":"#6dc87e" }].map(({ label,val,color }) => (
                <div key={label} style={{ background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:8, padding:"14px 10px", textAlign:"center" }}>
                  <div style={{ fontSize:8, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", marginBottom:6 }}>{label}</div>
                  <div style={{ fontSize:22, color, fontWeight:700, fontFamily:"monospace" }}>{val}</div>
                </div>
              ))}
            </div>
            {dueWords.length>0 ? (
              <div style={{ marginBottom:24, padding:"18px 22px", background:"rgba(200,110,110,0.06)", border:"1px solid rgba(200,110,110,0.2)", borderRadius:10, display:"flex", alignItems:"center", justifyContent:"space-between", gap:12 }}>
                <div>
                  <div style={{ fontSize:13, color:"#f0e8d8", marginBottom:4 }}><strong>{dueWords.length}</strong> word{dueWords.length!==1?"s":""} due for review today</div>
                  <div style={{ fontSize:11, color:"#7a6e5f", fontFamily:"monospace" }}>Three exercise types · Progress saved automatically</div>
                </div>
                <button onClick={startSession} style={{ background:"rgba(201,169,110,0.14)", border:"1px solid rgba(201,169,110,0.45)", borderRadius:8, padding:"12px 24px", cursor:"pointer", color:"#c9a96e", fontSize:12, fontFamily:"monospace", letterSpacing:2, whiteSpace:"nowrap", flexShrink:0 }}>STUDY NOW →</button>
              </div>
            ) : (
              <div style={{ marginBottom:24, padding:"18px 22px", background:"rgba(80,200,120,0.04)", border:"1px solid rgba(80,200,120,0.2)", borderRadius:10, textAlign:"center" }}>
                <div style={{ fontSize:14, color:"#6dc87e", marginBottom:4 }}>✓ All caught up for today!</div>
                <div style={{ fontSize:11, color:"#7a6e5f", fontFamily:"monospace" }}>
                  {(() => { const days=Object.keys(srsData).map(w=>daysUntilDue(srsData[w])).filter(d=>d>0); const m=days.length?Math.min(...days):null; return m?`Next review in ${m} day${m!==1?"s":""}`:null; })()}
                </div>
              </div>
            )}
            <div style={{ marginBottom:20 }}>
              <div style={{ fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", marginBottom:12 }}>WORD LIST</div>
              <div style={{ display:"flex", flexDirection:"column", gap:6 }}>
                {[...dueWords, ...allWords.filter(w=>!isDueToday(srsData[w]))].map(word => {
                  const s = srsData[word];
                  const due = isDueToday(s);
                  const days = daysUntilDue(s);
                  const reviewed = s?.totalReviews>0;
                  return (
                    <div key={word} style={{ display:"flex", alignItems:"center", justifyContent:"space-between", padding:"10px 14px", background:"rgba(255,255,255,0.02)", border:`1px solid ${due?"rgba(200,110,110,0.25)":"#2a2a3e"}`, borderRadius:6 }}>
                      <span style={{ fontSize:14, color:"#e8e0d0" }}>{word}</span>
                      <div style={{ display:"flex", gap:8, alignItems:"center" }}>
                        {(s?.lapses||0)>=2 && <span style={{ fontSize:9, color:"#c9a96e", fontFamily:"monospace" }}>⚠ weak</span>}
                        {due ? <span style={{ fontSize:9, background:"rgba(200,110,110,0.12)", border:"1px solid rgba(200,110,110,0.3)", borderRadius:10, padding:"2px 7px", color:"#c86e6e", fontFamily:"monospace" }}>DUE</span>
                          : reviewed ? <span style={{ fontSize:9, color:"#7a6e5f", fontFamily:"monospace" }}>in {days}d</span>
                          : <span style={{ fontSize:9, color:"#7a6e5f", fontFamily:"monospace" }}>new</span>}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
            <div style={{ display:"flex", gap:8, flexWrap:"wrap" }}>
              <button onClick={() => setView("add")} style={{ flex:1, background:"rgba(255,255,255,0.03)", border:"1px dashed #2a2a3e", borderRadius:8, padding:"12px", cursor:"pointer", color:"#7a6e5f", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>+ ADD WORDS</button>
              <button onClick={handleExport} style={{ background:"rgba(106,176,224,0.06)", border:"1px solid rgba(106,176,224,0.2)", borderRadius:8, padding:"12px 18px", cursor:"pointer", color:"#6ab0e0", fontSize:11, fontFamily:"monospace", letterSpacing:1 }}>↓ EXPORT</button>
              <button onClick={() => setImportOpen(true)} style={{ background:"rgba(106,176,224,0.06)", border:"1px solid rgba(106,176,224,0.2)", borderRadius:8, padding:"12px 18px", cursor:"pointer", color:"#6ab0e0", fontSize:11, fontFamily:"monospace", letterSpacing:1 }}>↑ IMPORT</button>
            </div>
          </>
        )}
      </div>
    );
  }

  // SESSION
  if (!currentCard || !currentData) return null;
  const isMC = currentCard.type!=='reverse';
  const progressPct = Math.round((currentIdx/queue.length)*100);
  const scorePct = sessionScore.total ? Math.round((sessionScore.correct/sessionScore.total)*100) : null;
  const typeLabels = { mc_def:"DEFINITION MC", fillblank:"FILL IN THE BLANK", reverse:"REVERSE RECALL" };
  const typeHints = { mc_def:`What does "${currentCard.word}" mean?`, fillblank:"Choose the word that completes the sentence:", reverse:"Type the word being described:" };

  return (
    <div style={{ animation:"fadeIn 0.3s ease" }}>
      <div style={{ marginBottom:20 }}>
        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
          <span style={{ fontSize:10, color:"#7a6e5f", fontFamily:"monospace" }}>{currentIdx+1} / {queue.length}</span>
          {scorePct!==null && <span style={{ fontSize:11, color:scorePct>=70?"#6dc87e":"#c9a96e", fontFamily:"monospace" }}>{sessionScore.correct}/{sessionScore.total} correct</span>}
        </div>
        <div style={{ background:"#1e1e2e", borderRadius:4, height:3, overflow:"hidden" }}>
          <div style={{ background:"#c9a96e", height:"100%", width:`${progressPct}%`, transition:"width 0.3s ease" }} />
        </div>
      </div>
      <div style={{ display:"flex", gap:8, marginBottom:18 }}>
        <span style={{ background:"rgba(201,169,110,0.08)", border:"1px solid rgba(201,169,110,0.3)", borderRadius:4, padding:"3px 10px", fontSize:10, letterSpacing:2, color:"#c9a96e", fontFamily:"monospace" }}>{typeLabels[currentCard.type]}</span>
        {currentData.register && <span style={{ background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:4, padding:"3px 10px", fontSize:10, color:"#7a6e5f", fontFamily:"monospace", textTransform:"uppercase" }}>{currentData.register}</span>}
      </div>
      <p style={{ margin:"0 0 18px", fontSize:13, color:"#9a8e7e", fontStyle:"italic" }}>{typeHints[currentCard.type]}</p>
      {currentCard.type==='mc_def' && (
        <div style={{ background:"rgba(255,255,255,0.025)", border:"1px solid #2a2a3e", borderLeft:"3px solid rgba(201,169,110,0.4)", borderRadius:8, padding:"28px", marginBottom:20, textAlign:"center" }}>
          <div style={{ fontSize:32, fontWeight:700, color:"#f0e8d8" }}>{currentCard.word}</div>
          {currentData.part_of_speech && <div style={{ fontSize:11, color:"#7a6e5f", fontFamily:"monospace", marginTop:8, fontStyle:"italic" }}>{currentData.part_of_speech}</div>}
        </div>
      )}
      {currentCard.type==='fillblank' && (
        <div style={{ background:"rgba(255,255,255,0.025)", border:"1px solid #2a2a3e", borderLeft:"3px solid rgba(201,169,110,0.35)", borderRadius:8, padding:"22px 26px", marginBottom:20, fontSize:17, lineHeight:2, color:"#e8e0d0" }}>
          {(() => {
            const parts = (currentData.example||"").split("_____");
            if (parts.length<2) return <span>{currentData.example}</span>;
            if (submitted) return <span>{parts[0]}<span style={{ color:submitted.correct?"#6dc87e":"#c86e6e", fontWeight:700 }}>{currentCard.word}</span>{parts[1]}</span>;
            return <span>{parts[0]}<span style={{ display:"inline-block", minWidth:100, borderBottom:"2px solid rgba(201,169,110,0.5)", margin:"0 4px" }}>&nbsp;</span>{parts[1]}</span>;
          })()}
        </div>
      )}
      {currentCard.type==='reverse' && (
        <div style={{ background:"rgba(255,255,255,0.025)", border:"1px solid #2a2a3e", borderLeft:"3px solid rgba(201,169,110,0.35)", borderRadius:8, padding:"22px 26px", marginBottom:20 }}>
          <div style={{ fontSize:16, lineHeight:1.9, color:"#e8e0d0", marginBottom:currentData.synonyms?.length?14:0 }}>{currentData.definition}</div>
          {currentData.synonyms?.length>0 && (
            <div style={{ display:"flex", gap:6, flexWrap:"wrap", alignItems:"center" }}>
              <span style={{ fontSize:9, color:"#7a6e5f", fontFamily:"monospace", letterSpacing:1 }}>SYNONYMS</span>
              {currentData.synonyms.map(s => <span key={s} style={{ fontSize:12, color:"#9a8e7e", background:"rgba(255,255,255,0.04)", border:"1px solid #2a2a3e", borderRadius:4, padding:"2px 8px", fontFamily:"monospace" }}>{s}</span>)}
            </div>
          )}
        </div>
      )}
      {!submitted && (
        isMC ? (
          <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:10, marginBottom:16 }}>
            {Object.entries(currentCard.options||{}).map(([letter,text]) => (
              <button key={letter} onClick={() => checkAnswer(letter)}
                style={{ background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:8, padding:"14px 16px", cursor:"pointer", color:"#e8e0d0", fontSize:currentCard.type==='mc_def'?12.5:15, textAlign:"left", display:"flex", gap:10, alignItems:"flex-start", lineHeight:1.5 }}
                onMouseEnter={e => { e.currentTarget.style.background="rgba(201,169,110,0.1)"; e.currentTarget.style.borderColor="rgba(201,169,110,0.3)"; }}
                onMouseLeave={e => { e.currentTarget.style.background="rgba(255,255,255,0.03)"; e.currentTarget.style.borderColor="#2a2a3e"; }}>
                <span style={{ color:"#c9a96e", fontFamily:"monospace", fontWeight:700, minWidth:20, flexShrink:0 }}>{letter}</span>
                <span>{text}</span>
              </button>
            ))}
          </div>
        ) : (
          <div style={{ display:"flex", gap:10 }}>
            <input value={textVal} onChange={e => setTextVal(e.target.value)}
              onKeyDown={e => e.key==="Enter" && textVal.trim() && checkAnswer(textVal.trim())}
              placeholder="Type the word..." autoFocus
              style={{ flex:1, background:"rgba(255,255,255,0.03)", border:"1px solid #2a2a3e", borderRadius:8, padding:"13px 18px", color:"#e8e0d0", fontSize:15, outline:"none" }}
            />
            <button onClick={() => textVal.trim() && checkAnswer(textVal.trim())}
              style={{ background:"rgba(201,169,110,0.12)", border:"1px solid rgba(201,169,110,0.35)", borderRadius:8, padding:"13px 22px", cursor:"pointer", color:"#c9a96e", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>CHECK</button>
          </div>
        )
      )}
      {submitted && (
        <div style={{ animation:"fadeIn 0.2s ease" }}>
          <div style={{ background:submitted.correct?"rgba(80,200,120,0.06)":"rgba(200,80,80,0.06)", border:`1px solid ${submitted.correct?"rgba(80,200,120,0.25)":"rgba(200,80,80,0.25)"}`, borderRadius:8, padding:"18px 22px", marginBottom:14 }}>
            <div style={{ fontSize:12, fontFamily:"monospace", letterSpacing:2, color:submitted.correct?"#6dc87e":"#c86e6e", marginBottom:8 }}>{submitted.correct?"✓  CORRECT":"✗  INCORRECT"}</div>
            <div style={{ display:"flex", alignItems:"baseline", gap:8 }}>
              <span style={{ fontSize:12, color:"#7a6e5f", fontFamily:"monospace" }}>WORD:</span>
              <span style={{ color:"#c9a96e", fontWeight:700, fontSize:18 }}>{currentCard.word}</span>
              {currentData.part_of_speech && <span style={{ fontSize:11, color:"#7a6e5f", fontFamily:"monospace", fontStyle:"italic" }}>{currentData.part_of_speech}</span>}
            </div>
            {submitted.correct && <div style={{ fontSize:11, color:"#7a6e5f", fontFamily:"monospace", marginTop:6 }}>Next review in ~{sm2Update(srsData[currentCard.word],1).interval} day{sm2Update(srsData[currentCard.word],1).interval!==1?"s":""}</div>}
          </div>
          <div style={{ marginBottom:12, padding:"16px 20px", background:"rgba(255,255,255,0.02)", border:"1px solid #2a2a3e", borderRadius:8 }}>
            <div style={{ fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", marginBottom:6 }}>DEFINITION</div>
            <div style={{ fontSize:13.5, color:"#c0b49e", lineHeight:1.75, marginBottom:currentData.example?14:0 }}>{currentData.definition}</div>
            {currentData.example && <>
              <div style={{ fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", marginBottom:6 }}>EXAMPLE</div>
              <div style={{ fontSize:13, color:"#9a8e7e", lineHeight:1.7, fontStyle:"italic" }}>{currentData.example.replace("_____",`[${currentCard.word}]`)}</div>
            </>}
          </div>
          {!submitted.correct && <div style={{ marginBottom:12, padding:"10px 16px", background:"rgba(100,120,255,0.04)", border:"1px solid rgba(100,120,255,0.15)", borderRadius:6, fontSize:12, color:"#8888cc", fontFamily:"monospace" }}>↩ Will come back for another try. Review scheduled for tomorrow.</div>}
          <button onClick={handleNext} style={{ background:"rgba(201,169,110,0.1)", border:"1px solid rgba(201,169,110,0.3)", borderRadius:8, padding:"12px 28px", cursor:"pointer", color:"#c9a96e", fontSize:12, fontFamily:"monospace", letterSpacing:2 }}>NEXT →</button>
        </div>
      )}
    </div>
  );
}

// ── USE OF ENGLISH SECTION ────────────────────────────────────────────────────
function UoESection({ apiKey }) {
  const [selectedType, setSelectedType] = useState("random");
  const [exercise, setExercise] = useState(null);
  const [exerciseId, setExerciseId] = useState(0);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [score, setScore] = useState({ correct:0, total:0 });
  const [history, setHistory] = useState([]);
  const queues = useRef({});

  const popOrFetch = async (taskType) => {
    if (taskType==="key_word_transformation") {
      if (!queues.current.__kwt_pool || queues.current.__kwt_pool.length===0) queues.current.__kwt_pool = shuffleArray(KWT_BANK);
      return queues.current.__kwt_pool.shift();
    }
    const q = queues.current[taskType] || [];
    if (q.length>0) {
      const next = q.shift();
      queues.current[taskType] = q;
      if (q.length<2) fetchBatch(taskType, apiKey).then(batch => { queues.current[taskType] = [...(queues.current[taskType]||[]),...batch]; }).catch(()=>{});
      return next;
    }
    const batch = await fetchBatch(taskType, apiKey);
    queues.current[taskType] = batch.slice(1);
    return batch[0];
  };

  const generate = async (type) => {
    setLoading(true); setExercise(null); setError(null);
    const types = TASK_TYPES.map(t=>t.id);
    const taskType = type==="random" ? types[Math.floor(Math.random()*types.length)] : type;
    try { const data = await popOrFetch(taskType); setExercise(data); setExerciseId(id=>id+1); }
    catch(e) { setError(e.message); }
    setLoading(false);
  };

  const handleNext = (wasCorrect) => {
    setScore(s => ({ correct:s.correct+(wasCorrect?1:0), total:s.total+1 }));
    setHistory(h => [...h, { type:exercise?.task_type, difficulty:exercise?.difficulty, correct:wasCorrect }]);
    generate(selectedType);
  };

  const pct = score.total ? Math.round((score.correct/score.total)*100) : null;

  return (
    <div>
      <div style={{ display:"flex", gap:5, marginBottom:16, overflowX:"auto", paddingBottom:4, WebkitOverflowScrolling:"touch" }}>
        {[{ id:"random",label:"ALL TYPES" },...TASK_TYPES.map(t=>({ id:t.id,label:t.label.toUpperCase() }))].map(t => (
          <button key={t.id} onClick={() => setSelectedType(t.id)}
            style={{ background:selectedType===t.id?"rgba(201,169,110,0.14)":"rgba(255,255,255,0.03)", border:selectedType===t.id?"1px solid rgba(201,169,110,0.4)":"1px solid #2a2a3e", borderRadius:6, padding:"5px 10px", cursor:"pointer", color:selectedType===t.id?"#c9a96e":"#7a6e5f", fontSize:10, fontFamily:"monospace", letterSpacing:0.5, whiteSpace:"nowrap", flexShrink:0 }}>
            {t.label}
          </button>
        ))}
      </div>
      {score.total>0 && (
        <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:16, padding:"10px 16px", background:"rgba(255,255,255,0.02)", border:"1px solid #2a2a3e", borderRadius:8 }}>
          <span style={{ fontSize:12, color:"#c9a96e", fontFamily:"monospace" }}>{score.correct}/{score.total}</span>
          <div style={{ flex:1, background:"#1e1e2e", borderRadius:4, height:4 }}>
            <div style={{ background:pct>=70?"#6dc87e":pct>=50?"#c9a96e":"#c86e6e", height:"100%", width:`${pct}%`, borderRadius:4, transition:"width 0.3s" }} />
          </div>
          <span style={{ fontSize:12, color:"#7a6e5f", fontFamily:"monospace" }}>{pct}%</span>
        </div>
      )}
      {!exercise && !loading && !error && (
        <div style={{ textAlign:"center", padding:"60px 0" }}>
          <div style={{ fontSize:48, marginBottom:20 }}>⚙️</div>
          <div style={{ fontSize:15, color:"#9a8e7e", marginBottom:8 }}>Ready to practise Use of English?</div>
          <div style={{ fontSize:12, color:"#7a6e5f", fontFamily:"monospace", marginBottom:32 }}>B2–C2 mixed difficulty · Instant feedback · Detailed explanations</div>
          <button onClick={() => generate(selectedType)} style={{ background:"rgba(201,169,110,0.12)", border:"1px solid rgba(201,169,110,0.4)", borderRadius:10, padding:"14px 36px", cursor:"pointer", color:"#c9a96e", fontSize:13, fontFamily:"monospace", letterSpacing:3 }}>START PRACTISING</button>
        </div>
      )}
      {loading && <Spinner text="GENERATING EXERCISE..." />}
      {error && <ErrorBox msg={error} onRetry={() => generate(selectedType)} />}
      {exercise && !loading && <UoECard key={exerciseId} exercise={exercise} onNext={handleNext} />}
      {history.length>0 && (
        <div style={{ marginTop:36, paddingTop:20, borderTop:"1px solid #1e1e2e" }}>
          <div style={{ fontSize:10, letterSpacing:2, color:"#7a6e5f", fontFamily:"monospace", marginBottom:10 }}>SESSION HISTORY</div>
          <div style={{ display:"flex", gap:5, flexWrap:"wrap" }}>
            {history.map((h,i) => <div key={i} style={{ width:10, height:10, borderRadius:"50%", background:h.correct?"#6dc87e":"#c86e6e", opacity:0.7 }} />)}
          </div>
        </div>
      )}
    </div>
  );
}

// ── MAIN APP ──────────────────────────────────────────────────────────────────
function App() {
  const [apiKey, setApiKey] = useState(() => LS.get("cpe-api-key", null));
  const [activeSection, setActiveSection] = useState("uoe");

  if (!apiKey) return <ApiKeyScreen onSave={k => { LS.set("cpe-api-key",k); setApiKey(k); }} />;

  return (
    <div style={{ height:"100vh", display:"flex", flexDirection:"column", background:"linear-gradient(160deg,#0c0c14 0%,#111118 60%,#0c0c14 100%)", overflow:"hidden" }}>
      {/* Header */}
      <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", padding:"10px 14px", borderBottom:"1px solid rgba(255,255,255,0.07)", background:"rgba(0,0,0,0.3)", flexShrink:0, gap:8, minHeight:52 }}>
        <div style={{ flexShrink:0 }}>
          <div style={{ fontSize:8, letterSpacing:3, color:"#7a6e5f", fontFamily:"monospace", textTransform:"uppercase" }}>Cambridge C2</div>
          <div style={{ fontSize:14, fontWeight:700, color:"#f0e8d8", marginTop:1 }}>CPE <span style={{ color:"#c9a96e" }}>Practice</span></div>
        </div>
        <div style={{ display:"flex", gap:5, overflowX:"auto" }}>
          {[{ id:"uoe",label:"Use of English" },{ id:"vocabulary",label:"Vocabulary" },{ id:"writing",label:"Writing" }].map(s => (
            <button key={s.id} onClick={() => setActiveSection(s.id)}
              style={{ background:activeSection===s.id?"rgba(201,169,110,0.14)":"rgba(255,255,255,0.03)", border:activeSection===s.id?"1px solid rgba(201,169,110,0.4)":"1px solid #2a2a3e", borderRadius:6, padding:"6px 10px", cursor:"pointer", color:activeSection===s.id?"#c9a96e":"#7a6e5f", fontSize:11, fontFamily:"monospace", letterSpacing:0.5, whiteSpace:"nowrap" }}>
              {s.label}
            </button>
          ))}
        </div>
        <button onClick={() => { if (confirm("Remove API key?")) { LS.set("cpe-api-key",null); setApiKey(null); } }}
          style={{ background:"transparent", border:"none", color:"#3a3a5e", cursor:"pointer", fontSize:11, fontFamily:"monospace", flexShrink:0 }} title="Change API key">⚙</button>
      </div>
      {/* Content */}
      <div style={{ flex:1, overflowY:"auto", WebkitOverflowScrolling:"touch" }}>
        <div style={{ maxWidth:680, margin:"0 auto", padding:"16px 12px 120px" }}>
          {activeSection==="uoe" && <UoESection apiKey={apiKey} />}
          {activeSection==="vocabulary" && <VocabularySection apiKey={apiKey} />}
          {activeSection==="writing" && <WritingSection apiKey={apiKey} />}
        </div>
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
